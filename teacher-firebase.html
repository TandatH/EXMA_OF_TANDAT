<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiÃ¡o ViÃªn - Quáº£n LÃ½ Thi Pro</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .hidden { display: none !important; }
        .card { max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; color: white; font-weight: bold; margin: 5px; }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-secondary { background: #6c757d; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        
        <div style="text-align: center; padding: 10px;">
            <span id="sysStatus" style="font-weight: bold; color: red;">ğŸ”´ Äang káº¿t ná»‘i...</span>
        </div>

        <div id="configSection" class="card hidden">
            <h1>âš™ï¸ Cáº¥u HÃ¬nh Firebase</h1>
            <p>Äang tá»± Ä‘á»™ng káº¿t ná»‘i...</p>
        </div>

        <div id="loginSection" class="card hidden">
            <h1>ÄÄƒng Nháº­p Admin</h1>
            <input type="text" id="teacherName" placeholder="TÃªn Ä‘Äƒng nháº­p (Máº·c Ä‘á»‹nh: admin)">
            <button onclick="login()" class="btn btn-primary">ÄÄƒng Nháº­p</button>
        </div>

        <div id="mainSection" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>Quáº£n LÃ½ Thi <span id="indicator">ğŸŸ¢</span></h1>
                <button onclick="logout()" class="btn btn-secondary">ÄÄƒng Xuáº¥t</button>
            </div>

            <h3>ğŸ“ Táº¡o Äá» Má»›i</h3>
            <input type="text" id="examTitle" placeholder="TÃªn Ä‘á» thi (VD: Kiá»ƒm tra 15 phÃºt)">
            <input type="number" id="duration" value="45" placeholder="Thá»i gian (phÃºt)">
            <textarea id="latex" rows="8" placeholder="\question 1+1=?&#10;\choice 1&#10;\CorrectChoice 2&#10;\choice 3"></textarea>
            <button onclick="createExam()" class="btn btn-primary">Xem TrÆ°á»›c & Táº¡o Äá»</button>

            <div id="preview" class="hidden" style="margin-top: 20px; border: 1px solid #ddd; padding: 10px;">
                <h2>Xem TrÆ°á»›c</h2>
                <div id="previewBox"></div>
                <br>
                <button onclick="saveExam()" class="btn btn-success">âœ… LÆ¯U & Láº¤Y MÃƒ</button>
            </div>

            <div id="codeBox" class="hidden" style="background: #e3f2fd; padding: 15px; margin-top: 15px; text-align: center; border-radius: 8px;">
                <h2>MÃƒ Äá»€ THI: <span id="code" style="color: blue; font-size: 24px;">...</span></h2>
                <button onclick="copy()" class="btn btn-secondary btn-sm">Copy MÃ£</button>
            </div>

            <hr style="margin: 30px 0;">

            <h3>ğŸ“‚ Äá» Äang Má»Ÿ</h3>
            <div id="activeList"></div>

            <hr style="margin: 30px 0;">

            <h3>ğŸ“Š Káº¿t Quáº£ Há»c Sinh</h3>
            <div style="margin-bottom: 15px;">
                <button onclick="downloadExcel()" class="btn btn-success">ğŸ“¥ Xuáº¥t Excel (KÃ¨m Thá»‘ng KÃª)</button>
                <button onclick="clearResults()" class="btn btn-danger">ğŸ—‘ï¸ XÃ³a Táº¥t Cáº£</button>
                <button onclick="refresh()" class="btn btn-secondary">ğŸ”„ LÃ m má»›i</button>
            </div>
            <div id="resultsList">
                <p>ChÆ°a cÃ³ bÃ i ná»™p nÃ o...</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ======================================================
        // ğŸ”´ ÄIá»€N THÃ”NG TIN FIREBASE Cá»¦A Báº N VÃ€O ÄÃ‚Y:
        // ======================================================
        const config = {
            apiKey: "AIzaSyADniEL6bbqGpa1a4O_k1Q0w5GRW5cfWjY", 
            databaseURL: "https://exam-project-4ef04-default-rtdb.firebaseio.com", 
            projectId: "exam-project-4ef04"
        };
        // ======================================================

        let db = null;
        let exam = null;
        let results = [];

        // 1. Káº¾T Ná»I
        window.onload = function() {
            try {
                if (config.databaseURL.endsWith("/")) config.databaseURL = config.databaseURL.slice(0, -1);
                config.authDomain = config.projectId + ".firebaseapp.com";
                if (!firebase.apps.length) firebase.initializeApp(config);
                db = firebase.database();

                db.ref(".info/connected").on("value", (snap) => {
                    const sysStatus = document.getElementById("sysStatus");
                    if (snap.val() === true) {
                        sysStatus.textContent = "ğŸŸ¢ ÄÃ£ káº¿t ná»‘i mÃ¡y chá»§";
                        sysStatus.style.color = "green";
                        if(localStorage.getItem("teacherLog")) {
                            document.getElementById("loginSection").classList.add("hidden");
                            document.getElementById("mainSection").classList.remove("hidden");
                            loadActiveExams();
                            loadResults();
                        } else {
                            document.getElementById("loginSection").classList.remove("hidden");
                        }
                    } else {
                        sysStatus.textContent = "ğŸ”´ Máº¥t káº¿t ná»‘i máº¡ng...";
                        sysStatus.style.color = "red";
                    }
                });
            } catch (e) { alert("âš ï¸ Lá»—i cáº¥u hÃ¬nh API Key!"); }
        };

        // 2. LOGIC CÆ  Báº¢N
        function login() {
            const name = document.getElementById("teacherName").value.trim();
            if (name) {
                localStorage.setItem("teacherLog", name);
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("mainSection").classList.remove("hidden");
                loadActiveExams();
                loadResults();
            } else alert("Nháº­p tÃªn Ä‘Äƒng nháº­p!");
        }

        function logout() { localStorage.removeItem("teacherLog"); location.reload(); }
        function refresh() { location.reload(); }
        function copy() { navigator.clipboard.writeText(document.getElementById("code").textContent); alert("ÄÃ£ copy!"); }

        // 3. Táº O Äá»€
        function createExam() {
            const title = document.getElementById("examTitle").value;
            const duration = document.getElementById("duration").value;
            const text = document.getElementById("latex").value;
            if (!title || !text) return alert("Thiáº¿u thÃ´ng tin!");

            const questions = [];
            const parts = text.split("\\question");
            parts.forEach(part => {
                if(!part.trim()) return;
                const lines = part.split("\n").filter(l => l.trim());
                const qText = lines[0];
                const choices = [];
                let correct = -1;
                lines.slice(1).forEach(line => {
                    if (line.includes("\\choice")) choices.push(line.replace("\\choice", "").trim());
                    if (line.includes("\\CorrectChoice")) { correct = choices.length; choices.push(line.replace("\\CorrectChoice", "").trim()); }
                });
                if (choices.length > 0) questions.push({ question: qText, choices: choices, correctAnswer: correct });
            });

            if (questions.length === 0) return alert("KhÃ´ng tÃ¬m tháº¥y cÃ¢u há»i!");
            exam = { title, duration: parseInt(duration), questions, active: true, createdAt: Date.now() };

            const previewBox = document.getElementById("previewBox");
            previewBox.innerHTML = questions.map((q, i) => `<div><b>CÃ¢u ${i+1}:</b> ${q.question}</div>`).join("<hr>");
            document.getElementById("preview").classList.remove("hidden");
        }

        function saveExam() {
            if (!exam) return;
            const code = Math.random().toString(36).substr(2, 6).toUpperCase();
            exam.code = code;
            db.ref("exams/" + code).set(exam).then(() => {
                document.getElementById("code").textContent = code;
                document.getElementById("codeBox").classList.remove("hidden");
                alert("âœ… MÃ£ Ä‘á»: " + code);
                loadActiveExams();
            });
        }

        function loadActiveExams() {
            db.ref("exams").orderByChild("active").equalTo(true).on("value", snap => {
                const list = document.getElementById("activeList");
                const data = snap.val() || {};
                list.innerHTML = Object.keys(data).length === 0 ? "<p>KhÃ´ng cÃ³ Ä‘á» nÃ o.</p>" : 
                Object.keys(data).map(k => `<div style="border-bottom:1px solid #eee; padding:5px; display:flex; justify-content:space-between;"><span><b>${k}</b> - ${data[k].title}</span><button class="btn-delete" onclick="closeExam('${k}')">ÄÃ³ng</button></div>`).join("");
            });
        }
        function closeExam(code) { if(confirm("ÄÃ³ng Ä‘á» nÃ y?")) db.ref("exams/" + code + "/active").set(false); }

        // 4. Káº¾T QUáº¢
        function loadResults() {
            db.ref("results").on("value", snap => {
                results = [];
                const data = snap.val() || {};
                if (!data) return document.getElementById("resultsList").innerHTML = "<p>ChÆ°a cÃ³ káº¿t quáº£.</p>";
                
                Object.keys(data).forEach(k => results.push(data[k]));
                results.sort((a, b) => b.timestamp - a.timestamp);

                let html = `<table><tr style="background:#f2f2f2;"><th>Thá»i gian</th><th>Há» tÃªn</th><th>MÃ£ Ä‘á»</th><th>Äiá»ƒm</th><th>Tráº¡ng thÃ¡i</th></tr>`;
                results.forEach(r => {
                    const status = r.tabSwitch ? '<span style="color:red; font-weight:bold;">âš ï¸ GIAN Láº¬N</span>' : '<span style="color:green;">Há»£p lá»‡</span>';
                    html += `<tr><td>${new Date(r.timestamp).toLocaleTimeString()}</td><td>${r.name}</td><td>${r.code}</td><td><b>${r.score}</b></td><td>${status}</td></tr>`;
                });
                document.getElementById("resultsList").innerHTML = html + "</table>";
            });
        }

        function clearResults() { if(confirm("XÃ³a háº¿t káº¿t quáº£?")) db.ref("results").remove(); }

        // 5. XUáº¤T EXCEL NÃ‚NG CAO (2 SHEET)
        function downloadExcel() {
            if (results.length === 0) return alert("ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!");

            // --- SHEET 1: CHI TIáº¾T ---
            const dataSheet1 = results.map((r, index) => ({
                "STT": index + 1,
                "Há» TÃªn": r.name,
                "MÃ£ Äá»": r.code,
                "Äiá»ƒm Sá»‘": parseFloat(r.score),
                "Sá»‘ CÃ¢u ÄÃºng": r.correct,
                "Tá»•ng Sá»‘ CÃ¢u": r.total,
                "Gian Láº­n": r.tabSwitch ? "CÃ“" : "KhÃ´ng",
                "Thá»i Gian Ná»™p": new Date(r.timestamp).toLocaleString()
            }));

            // --- SHEET 2: THá»NG KÃŠ ---
            const scores = results.map(r => parseFloat(r.score));
            const totalStudents = scores.length;
            const avgScore = (scores.reduce((a, b) => a + b, 0) / totalStudents).toFixed(2);
            
            const countGioi = scores.filter(s => s >= 8).length;
            const countKha = scores.filter(s => s >= 6.5 && s < 8).length;
            const countTB = scores.filter(s => s >= 5 && s < 6.5).length;
            const countYeu = scores.filter(s => s < 5).length;
            const countGianLan = results.filter(r => r.tabSwitch).length;

            const dataSheet2 = [
                { "TiÃªu chÃ­": "Tá»•ng sá»‘ há»c sinh", "GiÃ¡ trá»‹": totalStudents },
                { "TiÃªu chÃ­": "Äiá»ƒm trung bÃ¬nh", "GiÃ¡ trá»‹": avgScore },
                { "TiÃªu chÃ­": "Äiá»ƒm cao nháº¥t", "GiÃ¡ trá»‹": Math.max(...scores) },
                { "TiÃªu chÃ­": "Äiá»ƒm tháº¥p nháº¥t", "GiÃ¡ trá»‹": Math.min(...scores) },
                { "TiÃªu chÃ­": "", "GiÃ¡ trá»‹": "" }, // DÃ²ng trá»‘ng
                { "TiÃªu chÃ­": "Giá»i (>= 8.0)", "GiÃ¡ trá»‹": `${countGioi} (${(countGioi/totalStudents*100).toFixed(1)}%)` },
                { "TiÃªu chÃ­": "KhÃ¡ (6.5 - 7.9)", "GiÃ¡ trá»‹": `${countKha} (${(countKha/totalStudents*100).toFixed(1)}%)` },
                { "TiÃªu chÃ­": "Trung BÃ¬nh (5.0 - 6.4)", "GiÃ¡ trá»‹": `${countTB} (${(countTB/totalStudents*100).toFixed(1)}%)` },
                { "TiÃªu chÃ­": "Yáº¿u (< 5.0)", "GiÃ¡ trá»‹": `${countYeu} (${(countYeu/totalStudents*100).toFixed(1)}%)` },
                { "TiÃªu chÃ­": "", "GiÃ¡ trá»‹": "" },
                { "TiÃªu chÃ­": "Sá» LÆ¯á»¢NG GIAN Láº¬N", "GiÃ¡ trá»‹": countGianLan }
            ];

            // Táº O FILE EXCEL
            const wb = XLSX.utils.book_new();
            
            // ThÃªm Sheet 1
            const ws1 = XLSX.utils.json_to_sheet(dataSheet1);
            // Chá»‰nh Ä‘á»™ rá»™ng cá»™t Sheet 1
            ws1['!cols'] = [{wch:5}, {wch:25}, {wch:10}, {wch:10}, {wch:12}, {wch:12}, {wch:10}, {wch:20}];
            XLSX.utils.book_append_sheet(wb, ws1, "BangDiemChiTiet");

            // ThÃªm Sheet 2
            const ws2 = XLSX.utils.json_to_sheet(dataSheet2);
            // Chá»‰nh Ä‘á»™ rá»™ng cá»™t Sheet 2
            ws2['!cols'] = [{wch:25}, {wch:20}];
            XLSX.utils.book_append_sheet(wb, ws2, "ThongKeTongQuat");

            // Xuáº¥t file
            const date = new Date();
            const fileName = `KetQuaThi_${date.getDate()}${date.getMonth()+1}_${date.getHours()}h${date.getMinutes()}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>

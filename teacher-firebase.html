<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi√°o Vi√™n - Qu·∫£n L√Ω Thi (Full)</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Th√™m CSS s·ª≠a l·ªói nhanh */
        .hidden { display: none !important; }
        .active-row { background-color: #e8f5e9; }
        .btn-delete { background: #ff4444; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        
        <div style="text-align: center; padding: 10px;">
            <span id="sysStatus" style="font-weight: bold; color: red;">üî¥ ƒêang k·∫øt n·ªëi...</span>
        </div>

        <div id="configSection" class="card hidden">
            <h1>‚öôÔ∏è C·∫•u H√¨nh Firebase</h1>
            <p>ƒê√£ t√≠ch h·ª£p c·ª©ng trong code. ƒêang t·ª± ƒë·ªông k·∫øt n·ªëi...</p>
        </div>

        <div id="loginSection" class="card hidden">
            <h1>ƒêƒÉng Nh·∫≠p Admin</h1>
            <input type="text" id="teacherName" placeholder="T√™n ƒëƒÉng nh·∫≠p (M·∫∑c ƒë·ªãnh: admin)" class="input-field">
            <button onclick="login()" class="btn btn-primary">ƒêƒÉng Nh·∫≠p</button>
        </div>

        <div id="mainSection" class="card hidden">
            <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
                <h1>Qu·∫£n L√Ω Thi <span id="indicator">üü¢</span></h1>
                <button onclick="logout()" class="btn btn-secondary">ƒêƒÉng Xu·∫•t</button>
            </div>

            <div class="form-group">
                <label>T√™n ƒê·ªÅ:</label>
                <input type="text" id="examTitle" placeholder="VD: Ki·ªÉm tra 1 ti·∫øt To√°n" class="input-field">
            </div>

            <div class="form-group">
                <label>Th·ªùi Gian (ph√∫t):</label>
                <input type="number" id="duration" value="45" min="1" class="input-field">
            </div>

            <div class="form-group">
                <label>N·ªôi dung c√¢u h·ªèi (LaTeX):</label>
                <textarea id="latex" class="textarea-field" rows="10" placeholder="\question 1+1=?
\choice 1
\CorrectChoice 2
\choice 3"></textarea>
            </div>

            <button onclick="createExam()" class="btn btn-primary">Xem Tr∆∞·ªõc & T·∫°o ƒê·ªÅ</button>

            <div id="preview" class="hidden" style="margin-top: 20px; border: 1px solid #ddd; padding: 10px;">
                <h2>Xem Tr∆∞·ªõc</h2>
                <div id="previewBox" class="preview-box"></div>
                <br>
                <button onclick="saveExam()" class="btn btn-success">‚úÖ L∆ØU L√äN SERVER & L·∫§Y M√É</button>
            </div>

            <div id="codeBox" class="hidden" style="background: #e3f2fd; padding: 15px; margin-top: 15px; text-align: center; border-radius: 8px;">
                <h2>M√É ƒê·ªÄ THI: <span id="code" style="color: blue; font-size: 24px;">...</span></h2>
                <p>G·ª≠i m√£ n√†y cho h·ªçc sinh ƒë·ªÉ l√†m b√†i.</p>
            </div>

            <hr style="margin: 30px 0;">

            <div id="activeSection">
                <h2>Danh S√°ch ƒê·ªÅ ƒêang M·ªü</h2>
                <div id="activeList"></div>
            </div>

            <hr style="margin: 30px 0;">

            <div id="resultsSection">
                <h2>K·∫øt Qu·∫£ H·ªçc Sinh (Realtime)</h2>
                <div class="results-actions" style="margin-bottom: 15px;">
                    <button onclick="downloadExcel()" class="btn btn-success">üì• Xu·∫•t Excel</button>
                    <button onclick="clearResults()" class="btn btn-danger">üóëÔ∏è X√≥a T·∫•t C·∫£</button>
                    <button onclick="refresh()" class="btn btn-secondary">üîÑ L√†m m·ªõi</button>
                </div>
                <div id="resultsList" class="results-box">
                    <p>Ch∆∞a c√≥ b√†i n·ªôp n√†o...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ======================================================
        // üî¥ B∆Ø·ªöC QUAN TR·ªåNG: ƒêI·ªÄN TH√îNG TIN C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        // ======================================================
        const config = {
            apiKey: "AIzaSyADniEL6bbqGpa1a4O_k1Q0w5GRW5cfWjY", 
            databaseURL: "https://exam-project-4ef04-default-rtdb.firebaseio.com", 
            projectId: "exam-project-4ef04"
        };
        // ======================================================

        let db = null;
        let exam = null; // Bi·∫øn l∆∞u ƒë·ªÅ t·∫°m th·ªùi
        let results = []; // Bi·∫øn l∆∞u k·∫øt qu·∫£

        // 1. T·ª∞ ƒê·ªòNG K·∫æT N·ªêI
        window.onload = function() {
            try {
                if (config.databaseURL.endsWith("/")) config.databaseURL = config.databaseURL.slice(0, -1);
                config.authDomain = config.projectId + ".firebaseapp.com";

                if (!firebase.apps.length) firebase.initializeApp(config);
                db = firebase.database();

                const sysStatus = document.getElementById("sysStatus");
                
                db.ref(".info/connected").on("value", (snap) => {
                    if (snap.val() === true) {
                        sysStatus.textContent = "üü¢ ƒê√£ k·∫øt n·ªëi m√°y ch·ªß";
                        sysStatus.style.color = "green";
                        
                        // N·∫øu ƒë√£ t·ª´ng ƒëƒÉng nh·∫≠p th√¨ v√†o th·∫≥ng
                        if(localStorage.getItem("teacherLog")) {
                            document.getElementById("loginSection").classList.add("hidden");
                            document.getElementById("mainSection").classList.remove("hidden");
                            loadActiveExams();
                            loadResults();
                        } else {
                            document.getElementById("loginSection").classList.remove("hidden");
                        }
                    } else {
                        sysStatus.textContent = "üî¥ M·∫•t k·∫øt n·ªëi m·∫°ng...";
                        sysStatus.style.color = "red";
                    }
                });
            } catch (e) {
                alert("‚ö†Ô∏è L·ªói c·∫•u h√¨nh: Ch∆∞a ƒëi·ªÅn API Key v√†o code!");
            }
        };

        // 2. ƒêƒÇNG NH·∫¨P
        function login() {
            const name = document.getElementById("teacherName").value.trim();
            if (["admin", "giaovien", "teacher"].includes(name.toLowerCase()) || name.length > 0) {
                localStorage.setItem("teacherLog", name);
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("mainSection").classList.remove("hidden");
                loadActiveExams();
                loadResults();
            } else {
                alert("Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p!");
            }
        }

        function logout() {
            localStorage.removeItem("teacherLog");
            location.reload();
        }

        // 3. X·ª¨ L√ù ƒê·ªÄ THI (LATEX)
        function createExam() {
            const title = document.getElementById("examTitle").value;
            const duration = document.getElementById("duration").value;
            const text = document.getElementById("latex").value;

            if (!title || !text) return alert("Thi·∫øu ti√™u ƒë·ªÅ ho·∫∑c n·ªôi dung!");

            // Ph√¢n t√≠ch LaTeX
            const questions = [];
            const parts = text.split("\\question");
            
            parts.forEach(part => {
                if(!part.trim()) return;
                const lines = part.split("\n").filter(l => l.trim());
                const qText = lines[0];
                const choices = [];
                let correct = -1;

                lines.slice(1).forEach(line => {
                    if (line.includes("\\choice")) choices.push(line.replace("\\choice", "").trim());
                    if (line.includes("\\CorrectChoice")) {
                        correct = choices.length;
                        choices.push(line.replace("\\CorrectChoice", "").trim());
                    }
                });

                if (choices.length > 0) {
                    questions.push({ question: qText, choices: choices, correctAnswer: correct });
                }
            });

            if (questions.length === 0) return alert("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o!");

            exam = {
                title: title,
                duration: parseInt(duration),
                questions: questions,
                active: true,
                createdAt: Date.now()
            };

            // Hi·ªán xem tr∆∞·ªõc
            const previewBox = document.getElementById("previewBox");
            previewBox.innerHTML = questions.map((q, i) => 
                `<div><b>C√¢u ${i+1}:</b> ${q.question} <br> <i>ƒê√°p √°n: ${String.fromCharCode(65+q.correctAnswer)}</i></div>`
            ).join("<hr>");
            
            document.getElementById("preview").classList.remove("hidden");
        }

        // 4. L∆ØU ƒê·ªÄ L√äN SERVER
        function saveExam() {
            if (!exam) return;
            const code = Math.random().toString(36).substr(2, 6).toUpperCase();
            exam.code = code;

            db.ref("exams/" + code).set(exam).then(() => {
                document.getElementById("code").textContent = code;
                document.getElementById("codeBox").classList.remove("hidden");
                alert("‚úÖ ƒê√£ t·∫°o ƒë·ªÅ th√†nh c√¥ng!\nM√£ ƒë·ªÅ: " + code);
                loadActiveExams();
            }).catch(e => alert("L·ªói: " + e.message));
        }

        // 5. QU·∫¢N L√ù ƒê·ªÄ THI
        function loadActiveExams() {
            db.ref("exams").orderByChild("active").equalTo(true).on("value", snap => {
                const list = document.getElementById("activeList");
                const data = snap.val() || {};
                
                if (Object.keys(data).length === 0) {
                    list.innerHTML = "<p>Kh√¥ng c√≥ ƒë·ªÅ thi n√†o ƒëang m·ªü.</p>";
                    return;
                }

                list.innerHTML = Object.keys(data).map(key => {
                    const ex = data[key];
                    return `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                        <span><b>${key}</b> - ${ex.title} (${ex.duration} ph√∫t)</span>
                        <button class="btn-delete" onclick="closeExam('${key}')">ƒê√≥ng ƒê·ªÅ</button>
                    </div>`;
                }).join("");
            });
        }

        function closeExam(code) {
            if(confirm("H·ªçc sinh s·∫Ω kh√¥ng th·ªÉ v√†o thi ƒë·ªÅ n√†y n·ªØa?")) {
                db.ref("exams/" + code + "/active").set(false);
            }
        }

        // 6. XEM K·∫æT QU·∫¢ & EXCEL
        function loadResults() {
            db.ref("results").on("value", snap => {
                results = [];
                const data = snap.val() || {};
                const list = document.getElementById("resultsList");
                
                if (!data) {
                    list.innerHTML = "<p>Ch∆∞a c√≥ k·∫øt qu·∫£.</p>";
                    return;
                }

                // Chuy·ªÉn object th√†nh array
                Object.keys(data).forEach(key => {
                    results.push(data[key]);
                });

                // S·∫Øp x·∫øp m·ªõi nh·∫•t l√™n ƒë·∫ßu
                results.sort((a, b) => b.timestamp - a.timestamp);

                // Render b·∫£ng
                let html = `<table style="width:100%; border-collapse:collapse;">
                    <tr style="background:#f2f2f2;"><th>Th·ªùi gian</th><th>H·ªç t√™n</th><th>M√£ ƒë·ªÅ</th><th>ƒêi·ªÉm</th><th>C·∫£nh b√°o</th></tr>`;
                
                results.forEach(r => {
                    const time = new Date(r.timestamp).toLocaleTimeString();
                    const warning = r.tabSwitch ? '<span style="color:red">‚ö†Ô∏è Tab</span>' : '<span style="color:green">S·∫°ch</span>';
                    html += `<tr style="border-bottom:1px solid #ddd; text-align:center;">
                        <td>${time}</td>
                        <td style="font-weight:bold">${r.name}</td>
                        <td>${r.code}</td>
                        <td style="color:blue; font-weight:bold">${r.score}</td>
                        <td>${warning}</td>
                    </tr>`;
                });
                html += "</table>";
                list.innerHTML = html;
            });
        }

        function downloadExcel() {
            if (results.length === 0) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu!");
            
            const dataExport = results.map(r => ({
                "Th·ªùi Gian": new Date(r.timestamp).toLocaleString(),
                "H·ªç T√™n": r.name,
                "M√£ ƒê·ªÅ": r.code,
                "ƒêi·ªÉm": parseFloat(r.score),
                "S·ªë C√¢u ƒê√∫ng": r.correct,
                "T·ªïng C√¢u": r.total,
                "Gian L·∫≠n": r.tabSwitch ? "C√≥ (Chuy·ªÉn Tab)" : "Kh√¥ng"
            }));

            const ws = XLSX.utils.json_to_sheet(dataExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "KetQuaThi");
            XLSX.writeFile(wb, "DanhSachDiem.xlsx");
        }

        function clearResults() {
            if(confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: X√≥a to√†n b·ªô k·∫øt qu·∫£ thi?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ph·ª•c h·ªìi!")) {
                db.ref("results").remove();
                alert("ƒê√£ x√≥a s·∫°ch d·ªØ li·ªáu.");
            }
        }

        function refresh() {
            location.reload();
        }

        function copy() {
             const code = document.getElementById("code").textContent;
             navigator.clipboard.writeText(code);
             alert("ƒê√£ copy: " + code);
        }
    </script>
</body>
</html>

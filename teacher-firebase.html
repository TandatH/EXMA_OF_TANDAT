<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi√°o Vi√™n - Qu·∫£n L√Ω Thi Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #6366f1; /* M√†u t√≠m hi·ªán ƒë·∫°i */
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f1f5f9;
            --bg: #f8fafc;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            color: #334155;
        }

        /* --- UI COMPONENT --- */
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }

        .header-card {
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-card h1 { margin: 0; font-size: 1.5rem; }

        .hidden { display: none !important; }

        /* BUTTONS */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #94a3b8; color: white; }
        .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; }

        /* INPUTS */
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
            font-family: inherit;
        }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* EDITOR 2 C·ªòT */
        .editor-container {
            display: flex;
            gap: 20px;
            height: 550px;
            margin-top: 15px;
        }
        .editor-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .toolbar {
            padding: 10px 15px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toolbar-title { font-size: 0.85rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }

        #inputArea {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            outline: none;
            font-size: 15px;
            line-height: 1.6;
        }
        #inputArea[contenteditable]:empty::before {
            content: "üëâ B∆∞·ªõc 1: Copy ƒë·ªÅ t·ª´ Word d√°n v√†o ƒë√¢y.\nüëâ B∆∞·ªõc 2: B·∫•m 'Th√™m ·∫¢nh' ƒë·ªÉ ch√®n h√¨nh.\nüëâ L∆∞u √Ω: ƒê√°p √°n ƒë√∫ng ph·∫£i ƒë∆∞·ª£c T√î ƒê·ªé trong Word.";
            color: #94a3b8;
            white-space: pre-wrap;
        }
        #inputArea img {
            max-width: 150px;
            border-radius: 8px;
            border: 2px dashed var(--primary);
            margin: 5px 0;
            display: block;
        }

        #examInput {
            flex: 1;
            padding: 15px;
            background: #1e1e1e;
            color: #a5b4fc;
            border: none;
            resize: none;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }

        /* PREVIEW BOX */
        .preview-item {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            padding-left: 50px;
        }
        .preview-badge {
            position: absolute;
            top: 15px;
            left: 10px;
            background: var(--primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        .preview-content img { max-width: 100%; border-radius: 6px; margin-top: 10px; }
        .correct-ans-preview { color: var(--success); font-weight: bold; }

        /* TABLE */
        .modern-table { width: 100%; border-collapse: collapse; margin-top: 10px; border-radius: 8px; overflow: hidden; }
        .modern-table th { background: #f1f5f9; color: #475569; font-weight: 600; text-align: left; padding: 12px; }
        .modern-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; color: #334155; }
        .modern-table tr:last-child td { border-bottom: none; }
        .status-badge { padding: 4px 8px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .status-open { background: #dcfce7; color: #166534; }
        .status-closed { background: #fee2e2; color: #991b1b; }

        /* LOADING */
        .loading-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid var(--primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 10px; font-weight: 600; color: var(--primary);">ƒêang x·ª≠ l√Ω...</p>
    </div>

    <div class="container">
        <div id="statusHeader" style="text-align: center; margin-bottom: 10px; font-size: 0.9rem;">
            <span id="sysStatus" style="color: #64748b;">üîÑ ƒêang k·∫øt n·ªëi...</span>
        </div>

        <div id="loginSection" class="card hidden" style="max-width: 400px; margin: 50px auto; text-align: center;">
            <h2 style="color: var(--primary);">üîê ƒêƒÉng Nh·∫≠p Gi√°o Vi√™n</h2>
            <p style="color: #64748b; font-size: 0.9rem;">H·ªá th·ªëng qu·∫£n l√Ω thi tr·ª±c tuy·∫øn</p>
            <input type="text" id="teacherName" placeholder="T√™n ƒëƒÉng nh·∫≠p (admin)" style="text-align: center; font-size: 1rem;">
            <button onclick="login()" class="btn btn-primary" style="width: 100%; justify-content: center;">Truy C·∫≠p H·ªá Th·ªëng</button>
        </div>

        <div id="mainSection" class="hidden">
            
            <div class="card header-card">
                <div>
                    <h1>B·∫£ng ƒêi·ªÅu Khi·ªÉn</h1>
                    <div style="font-size: 0.9rem; opacity: 0.9;">Xin ch√†o, <span id="welcomeName">Gi√°o vi√™n</span></div>
                </div>
                <button onclick="logout()" class="btn btn-outline">ƒêƒÉng Xu·∫•t</button>
            </div>

            <div class="card">
                <h3 style="display: flex; align-items: center; gap: 10px; margin-top: 0;">
                    üìù So·∫°n Th·∫£o ƒê·ªÅ Thi
                    <span style="font-size: 0.8rem; font-weight: normal; color: #64748b; margin-left: auto;">H·ªó tr·ª£ Word & ·∫¢nh</span>
                </h3>

                <div style="display: flex; gap: 10px;">
                    <input type="text" id="examTitle" placeholder="Nh·∫≠p t√™n b√†i thi (VD: Ki·ªÉm tra 1 ti·∫øt To√°n)" style="flex: 3;">
                    <input type="number" id="duration" value="45" placeholder="Ph√∫t" style="flex: 1;">
                </div>

                <div class="editor-container">
                    <div class="editor-col">
                        <div class="toolbar">
                            <span class="toolbar-title">N·ªôi Dung (Word)</span>
                            <div>
                                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                                <button class="btn btn-primary" style="padding: 5px 12px; font-size: 0.8rem;" onclick="document.getElementById('fileInput').click()">
                                    üì∑ Th√™m ·∫¢nh
                                </button>
                            </div>
                        </div>
                        <div id="inputArea" contenteditable="true" oninput="debounceConversion()"></div>
                    </div>

                    <div class="editor-col">
                        <div class="toolbar">
                            <span class="toolbar-title">M√£ Ngu·ªìn (T·ª± ƒê·ªông)</span>
                            <button class="btn btn-success" style="padding: 5px 12px; font-size: 0.8rem;" onclick="processConversion()">üîÑ C·∫≠p nh·∫≠t</button>
                        </div>
                        <textarea id="examInput" readonly placeholder="Code s·∫Ω t·ª± ƒë·ªông sinh ra t·∫°i ƒë√¢y..."></textarea>
                    </div>
                </div>

                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="createExam()" class="btn btn-primary">üëÅÔ∏è Xem Tr∆∞·ªõc & T·∫°o ƒê·ªÅ</button>
                </div>
            </div>

            <div id="previewSection" class="card hidden" style="border: 2px solid var(--primary);">
                <h3 style="color: var(--primary);">üëÅÔ∏è Xem Tr∆∞·ªõc ƒê·ªÅ Thi</h3>
                <div id="previewBox" style="max-height: 400px; overflow-y: auto; padding: 10px; background: #f8fafc; border-radius: 8px;"></div>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="saveExam()" class="btn btn-success" style="font-size: 1.1rem; padding: 12px 30px;">üöÄ L∆ØU ƒê·ªÄ L√äN SERVER</button>
                    <button onclick="document.getElementById('previewSection').classList.add('hidden')" class="btn btn-secondary">H·ªßy</button>
                </div>
            </div>

            <div id="codeBox" class="card hidden" style="background: #e0e7ff; border: 1px solid #c7d2fe; text-align: center;">
                <h2 style="color: var(--primary); margin: 0;">üéâ T·∫†O TH√ÄNH C√îNG!</h2>
                <div style="margin: 15px 0;">
                    M√É ƒê·ªÄ THI: <span id="code" style="font-size: 2rem; font-weight: bold; color: #4338ca; background: white; padding: 5px 20px; border-radius: 8px; border: 2px dashed #4338ca;">ABC123</span>
                </div>
                <button onclick="copy()" class="btn btn-primary">Sao ch√©p M√£</button>
            </div>

            <div class="card">
                <h3>üìÇ Danh S√°ch ƒê·ªÅ ƒêang M·ªü</h3>
                <div id="activeList">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>üìä K·∫øt Qu·∫£ Thi (Real-time)</h3>
                    <div>
                        <button onclick="downloadExcel()" class="btn btn-success">üì• Xu·∫•t Excel</button>
                        <button onclick="clearResults()" class="btn btn-danger">üóëÔ∏è X√≥a All</button>
                    </div>
                </div>
                <div id="resultsList" style="margin-top: 15px;">
                    <p style="color: #64748b;">Ch∆∞a c√≥ b√†i n·ªôp n√†o...</p>
                </div>
            </div>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ===========================================
        // üî¥ C·∫§U H√åNH FIREBASE
        // ===========================================
        const config = {
            apiKey: "AIzaSyADniEL6bbqGpa1a4O_k1Q0w5GRW5cfWjY", 
            databaseURL: "https://exam-project-4ef04-default-rtdb.firebaseio.com", 
            projectId: "exam-project-4ef04"
        };
        const CLOUD_NAME = "dpvh5ksdr";
        const UPLOAD_PRESET = "web_thi";

        let db = null;
        let exam = null;
        let results = [];
        let conversionTimeout;

        // --- 1. LOGIC UPLOAD ·∫¢NH (GI·ªÆ NGUY√äN) ---
        async function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('loading').style.display = 'flex';
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: 'POST', body: formData
                });
                const data = await res.json();
                if (data.secure_url) {
                    insertImageAtCursor(data.secure_url);
                } else {
                    alert('L·ªói: ' + (data.error?.message || 'Upload th·∫•t b·∫°i'));
                }
            } catch (e) {
                alert('L·ªói k·∫øt n·ªëi upload ·∫£nh!');
            } finally {
                document.getElementById('loading').style.display = 'none';
                input.value = '';
            }
        }

        function insertImageAtCursor(url) {
            const img = document.createElement('img');
            img.src = url;
            img.setAttribute('data-cloud-url', url);
            const sel = window.getSelection();
            const inputArea = document.getElementById('inputArea');
            if (sel.rangeCount > 0 && inputArea.contains(sel.getRangeAt(0).commonAncestorContainer)) {
                const range = sel.getRangeAt(0);
                range.deleteContents();
                range.insertNode(img);
                range.collapse(false);
            } else {
                inputArea.appendChild(img);
            }
            processConversion();
        }

        // --- 2. LOGIC X·ª¨ L√ù WORD & M√ÄU ƒê·ªé (QUAN TR·ªåNG ƒê√É FIX) ---
        function debounceConversion() {
            clearTimeout(conversionTimeout);
            conversionTimeout = setTimeout(processConversion, 1000);
        }

        // H√†m ki·ªÉm tra m√†u ƒë·ªè - "ƒê√†o s√¢u" m·ªçi ng√≥c ng√°ch c·ªßa th·∫ª HTML
        function checkColorIsRedRecursive(node) {
            // 1. Ki·ªÉm tra node hi·ªán t·∫°i (n·∫øu l√† Element)
            if (node.nodeType === 1) {
                const style = node.style;
                const computed = window.getComputedStyle(node);
                
                // Check style inline ho·∫∑c computed
                if (isRed(style.color) || isRed(computed.color)) return true;
                
                // Check th·∫ª <font color="red"> (Word c≈© hay d√πng)
                if (node.tagName === 'FONT' && node.getAttribute('color') === 'red') return true;
                if (node.getAttribute('color') === '#ff0000') return true;
            }

            // 2. N·∫øu l√† Text Node, ki·ªÉm tra cha n√≥
            if (node.nodeType === 3 && node.parentNode) {
                 const parent = node.parentNode;
                 if (parent.nodeType === 1) {
                     const pStyle = window.getComputedStyle(parent);
                     if (isRed(pStyle.color) || isRed(parent.style.color)) return true;
                 }
            }

            // 3. ƒê·ªá quy con c√°i (T√¨m xem b√™n trong c√≥ th·∫ª con n√†o m√†u ƒë·ªè kh√¥ng)
            if (node.childNodes && node.childNodes.length > 0) {
                for (let i = 0; i < node.childNodes.length; i++) {
                    if (checkColorIsRedRecursive(node.childNodes[i])) return true;
                }
            }
            return false;
        }

        // Helper: ƒê·ªãnh nghƒ©a th·∫ø n√†o l√† m√†u ƒë·ªè
        function isRed(colorStr) {
            if (!colorStr) return false;
            if (colorStr === 'red') return true;
            if (colorStr.includes('#ff0000') || colorStr.includes('#FF0000')) return true;
            // Check RGB: red > 200, green & blue < 100
            const match = colorStr.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
            if (match) {
                const [r, g, b] = [parseInt(match[1]), parseInt(match[2]), parseInt(match[3])];
                return (r > 200 && g < 100 && b < 100);
            }
            return false;
        }

        function processConversion() {
            const inputArea = document.getElementById('inputArea');
            // D√πng childNodes ƒë·ªÉ duy·ªát t·ª´ng d√≤ng/ƒëo·∫°n
            const nodes = inputArea.childNodes;
            let result = "";
            let questionBuffer = "";
            
            const regexAnswerStart = /^([A-D])[\.\)]\s*/i;
            const regexQuestionNumber = /^(C√¢u\s+\d+[:.]|B√†i\s+\d+[:.]|\d+[\.:])\s*/i;

            for (let i = 0; i < nodes.length; i++) {
                let node = nodes[i];
                let rawText = node.textContent || "";
                let cleanText = rawText.replace(/[\r\n\t]+/g, " ").replace(/\s\s+/g, " ").trim();
                
                // L·∫•y ·∫£nh
                let imgCode = "";
                if (node.nodeType === 1) {
                    let imgs = node.tagName === 'IMG' ? [node] : node.querySelectorAll('img');
                    imgs.forEach(img => {
                        const url = img.getAttribute('data-cloud-url') || img.src;
                        imgCode += `<br><img src="${url}" class="exam-image" style="max-width:100%; display:block; margin:10px auto;" /><br>`;
                    });
                }

                if (!cleanText && !imgCode) continue;

                if (regexAnswerStart.test(cleanText)) {
                    // --- PH√ÅT HI·ªÜN ƒê√ÅP √ÅN ---
                    if (questionBuffer.length > 0) {
                        result += `\n\\question ${questionBuffer.trim()}\n`;
                        questionBuffer = "";
                    }
                    
                    let match = cleanText.match(regexAnswerStart);
                    let content = cleanText.substring(match[0].length).trim();
                    
                    // üî• KI·ªÇM TRA M√ÄU ƒê·ªé ·ªû ƒê√ÇY üî•
                    // Ki·ªÉm tra node hi·ªán t·∫°i, v√† c·∫£ node con b√™n trong
                    if (checkColorIsRedRecursive(node)) {
                        result += `\\CorrectChoice ${content}\n`;
                    } else {
                        result += `\\choice ${content}\n`;
                    }

                } else {
                    // --- L√Ä C√ÇU H·ªéI ---
                    cleanText = cleanText.replace(regexQuestionNumber, ""); // X√≥a "C√¢u 1:"
                    if (cleanText) questionBuffer += " " + cleanText;
                    if (imgCode) questionBuffer += imgCode;
                }
            }
            
            if (questionBuffer.length > 0) result += `\n\\question ${questionBuffer.trim()}\n`;
            document.getElementById('examInput').value = result.trim();
        }

        // --- 3. LOGIC FIREBASE & APP (GI·ªÆ NGUY√äN) ---
        window.onload = function() {
            try {
                if (config.databaseURL.endsWith("/")) config.databaseURL = config.databaseURL.slice(0, -1);
                config.authDomain = config.projectId + ".firebaseapp.com";
                if (!firebase.apps.length) firebase.initializeApp(config);
                db = firebase.database();

                db.ref(".info/connected").on("value", (snap) => {
                    const st = document.getElementById("sysStatus");
                    if (snap.val() === true) {
                        st.innerHTML = "üü¢ ƒê√£ k·∫øt n·ªëi m√°y ch·ªß";
                        st.style.color = "var(--success)";
                        if(localStorage.getItem("teacherLog")) {
                            document.getElementById("loginSection").classList.add("hidden");
                            document.getElementById("mainSection").classList.remove("hidden");
                            document.getElementById("welcomeName").innerText = localStorage.getItem("teacherLog");
                            loadActiveExams();
                            loadResults();
                        } else {
                            document.getElementById("loginSection").classList.remove("hidden");
                        }
                    } else {
                        st.innerHTML = "üî¥ M·∫•t k·∫øt n·ªëi...";
                        st.style.color = "var(--danger)";
                    }
                });
            } catch (e) { alert("L·ªói Config!"); }
        };

        function login() {
            const name = document.getElementById("teacherName").value.trim();
            if (name) {
                localStorage.setItem("teacherLog", name);
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("mainSection").classList.remove("hidden");
                document.getElementById("welcomeName").innerText = name;
                loadActiveExams();
                loadResults();
            } else alert("Vui l√≤ng nh·∫≠p t√™n!");
        }
        function logout() { localStorage.removeItem("teacherLog"); location.reload(); }
        function copy() { navigator.clipboard.writeText(document.getElementById("code").textContent); alert("ƒê√£ copy m√£!"); }

        function createExam() {
            processConversion(); 
            const title = document.getElementById("examTitle").value;
            const duration = document.getElementById("duration").value;
            const text = document.getElementById("examInput").value;

            if (!title || !text) return alert("Thi·∫øu t√™n ƒë·ªÅ ho·∫∑c n·ªôi dung!");

            const questions = [];
            const parts = text.split("\\question");
            parts.forEach(part => {
                if(!part.trim()) return;
                const lines = part.split("\n").filter(l => l.trim());
                const qText = lines[0]; 
                const choices = [];
                let correct = -1;
                lines.slice(1).forEach(line => {
                    if (line.includes("\\choice")) choices.push(line.replace("\\choice", "").trim());
                    if (line.includes("\\CorrectChoice")) { correct = choices.length; choices.push(line.replace("\\CorrectChoice", "").trim()); }
                });
                if (choices.length > 0) questions.push({ question: qText, choices: choices, correctAnswer: correct });
            });

            if (questions.length === 0) return alert("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi! (Ki·ªÉm tra l·∫°i xem ƒë√£ Enter xu·ªëng d√≤ng gi·ªØa c√°c c√¢u ch∆∞a)");
            exam = { title, duration: parseInt(duration), questions, active: true, createdAt: Date.now() };

            const previewBox = document.getElementById("previewBox");
            // Hi·ªÉn th·ªã Preview
            previewBox.innerHTML = questions.map((q, i) => {
                // ƒê√°nh d·∫•u ƒë√°p √°n ƒë√∫ng trong preview
                const choicesHtml = q.choices.map((c, idx) => 
                    `<div style="${idx === q.correctAnswer ? 'color:green; font-weight:bold;' : ''}">${String.fromCharCode(65+idx)}. ${c} ${idx === q.correctAnswer ? '‚úÖ' : ''}</div>`
                ).join("");

                return `
                <div class="preview-item">
                    <div class="preview-badge">${i+1}</div>
                    <div class="preview-content">
                        <strong>${q.question}</strong>
                        <div style="margin-top:5px; margin-left: 10px;">
                            ${choicesHtml}
                        </div>
                    </div>
                </div>`;
            }).join("");
            
            document.getElementById("previewSection").classList.remove("hidden");
            document.getElementById("previewSection").scrollIntoView({behavior: "smooth"});
        }

        function saveExam() {
            if (!exam) return;
            const code = Math.random().toString(36).substr(2, 6).toUpperCase();
            exam.code = code;
            db.ref("exams/" + code).set(exam).then(() => {
                document.getElementById("code").textContent = code;
                document.getElementById("previewSection").classList.add("hidden");
                document.getElementById("codeBox").classList.remove("hidden");
                loadActiveExams();
            });
        }

        function loadActiveExams() {
            db.ref("exams").orderByChild("active").equalTo(true).on("value", snap => {
                const list = document.getElementById("activeList");
                const data = snap.val() || {};
                if(Object.keys(data).length === 0) {
                    list.innerHTML = "<p>Kh√¥ng c√≥ ƒë·ªÅ n√†o ƒëang m·ªü.</p>";
                    return;
                }
                
                let html = `<table class="modern-table"><thead><tr><th>M√£</th><th>T√™n ƒê·ªÅ</th><th>Tr·∫°ng Th√°i</th><th>H√†nh ƒê·ªông</th></tr></thead><tbody>`;
                Object.keys(data).forEach(k => {
                    html += `
                        <tr>
                            <td><strong>${k}</strong></td>
                            <td>${data[k].title}</td>
                            <td><span class="status-badge status-open">ƒêang m·ªü</span></td>
                            <td><button class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="closeExam('${k}')">ƒê√≥ng ƒê·ªÅ</button></td>
                        </tr>
                    `;
                });
                list.innerHTML = html + "</tbody></table>";
            });
        }
        function closeExam(code) { if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng ƒë·ªÅ n√†y? H·ªçc sinh s·∫Ω kh√¥ng th·ªÉ v√†o thi n·ªØa.")) db.ref("exams/" + code + "/active").set(false); }

        function loadResults() {
            db.ref("results").on("value", snap => {
                results = [];
                const data = snap.val() || {};
                if (!data) return document.getElementById("resultsList").innerHTML = "<p>Ch∆∞a c√≥ k·∫øt qu·∫£.</p>";
                
                Object.keys(data).forEach(k => results.push(data[k]));
                results.sort((a, b) => b.timestamp - a.timestamp);

                let html = `<table class="modern-table">
                    <thead><tr><th>Th·ªùi gian</th><th>H·ªç t√™n</th><th>M√£ ƒë·ªÅ</th><th>ƒêi·ªÉm</th><th>Tr·∫°ng th√°i</th></tr></thead>
                    <tbody>`;
                results.forEach(r => {
                    const isCheat = r.tabSwitch;
                    html += `<tr>
                        <td>${new Date(r.timestamp).toLocaleTimeString()}</td>
                        <td>${r.name}</td>
                        <td>${r.code}</td>
                        <td style="font-weight:bold; color:${parseFloat(r.score) >= 5 ? 'var(--success)' : 'var(--danger)'}">${r.score}</td>
                        <td>${isCheat ? '<span style="color:red">‚ö†Ô∏è Gian l·∫≠n</span>' : '<span style="color:green">H·ª£p l·ªá</span>'}</td>
                    </tr>`;
                });
                document.getElementById("resultsList").innerHTML = html + "</tbody></table>";
            });
        }

        function clearResults() { if(confirm("C·∫¢NH B√ÅO: X√≥a t·∫•t c·∫£ k·∫øt qu·∫£ thi?")) db.ref("results").remove(); }

        function downloadExcel() {
            if (results.length === 0) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu!");
            
            const dataSheet1 = results.map((r, index) => ({
                "STT": index + 1,
                "H·ªç v√† T√™n": r.name,
                "M√£ ƒê·ªÅ": r.code,
                "ƒêi·ªÉm S·ªë": parseFloat(r.score),
                "S·ªë C√¢u ƒê√∫ng": r.correct,
                "T·ªïng S·ªë C√¢u": r.total,
                "Gian L·∫≠n (R·ªùi tab)": r.tabSwitch ? "C√ì" : "Kh√¥ng",
                "Th·ªùi Gian N·ªôp": new Date(r.timestamp).toLocaleString()
            }));

            const scores = results.map(r => parseFloat(r.score));
            const avg = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
            
            const dataSheet2 = [
                { "Th·ªëng K√™": "T·ªïng s·ªë h·ªçc sinh", "Gi√° tr·ªã": scores.length },
                { "Th·ªëng K√™": "ƒêi·ªÉm trung b√¨nh", "Gi√° tr·ªã": avg },
                { "Th·ªëng K√™": "Gi·ªèi (>=8)", "Gi√° tr·ªã": scores.filter(s=>s>=8).length },
                { "Th·ªëng K√™": "Y·∫øu (<5)", "Gi√° tr·ªã": scores.filter(s=>s<5).length },
                { "Th·ªëng K√™": "Gian l·∫≠n", "Gi√° tr·ªã": results.filter(r=>r.tabSwitch).length }
            ];

            const wb = XLSX.utils.book_new();
            const ws1 = XLSX.utils.json_to_sheet(dataSheet1);
            const ws2 = XLSX.utils.json_to_sheet(dataSheet2);
            
            ws1['!cols'] = [{wch:5}, {wch:25}, {wch:10}, {wch:10}, {wch:12}, {wch:12}, {wch:15}, {wch:22}];
            ws2['!cols'] = [{wch:20}, {wch:15}];

            XLSX.utils.book_append_sheet(wb, ws1, "BangDiem");
            XLSX.utils.book_append_sheet(wb, ws2, "ThongKe");
            XLSX.writeFile(wb, `KetQuaThi_${new Date().getTime()}.xlsx`);
        }
    </script>
</body>
</html>

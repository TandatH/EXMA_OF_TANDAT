// TEACHER-FIREBASE.JS
let db=null,exam=null,results=[],listener=null;function saveConfig(){const e={apiKey:document.getElementById("apiKey").value.trim(),databaseURL:document.getElementById("databaseURL").value.trim(),projectId:document.getElementById("projectId").value.trim(),authDomain:document.getElementById("projectId").value.trim()+".firebaseapp.com"};if(!e.apiKey||!e.databaseURL||!e.projectId)return void alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß!");try{firebase.apps.length||firebase.initializeApp(e),db=firebase.database(),localStorage.setItem("fbConfig",JSON.stringify(e)),db.ref(".info/connected").once("value",e=>{e.val()&&(updateStatus(!0),document.getElementById("configSection").classList.add("hidden"),document.getElementById("loginSection").classList.remove("hidden"),alert("‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!"))}),db.ref(".info/connected").on("value",e=>{updateStatus(e.val())})}catch(e){alert("L·ªói: "+e.message)}}function useLocal(){alert("‚ö†Ô∏è Ch·∫ø ƒë·ªô Offline"),document.getElementById("configSection").classList.add("hidden"),document.getElementById("loginSection").classList.remove("hidden")}function reconfig(){localStorage.removeItem("fbConfig"),document.getElementById("loginSection").classList.add("hidden"),document.getElementById("configSection").classList.remove("hidden")}function updateStatus(e){const t=document.getElementById("status"),n=document.getElementById("indicator");t&&(t.textContent=e?"üü¢ ƒê√£ k·∫øt n·ªëi":"üî¥ M·∫•t k·∫øt n·ªëi"),n&&(n.textContent=e?"üü¢":"üî¥")}function login(){const e=document.getElementById("teacherName").value.trim();(["admin","giaovien","teacher"].includes(e)||e.toLowerCase().includes("gi√°o vi√™n"))?(localStorage.setItem("teacher",e),document.getElementById("loginSection").classList.add("hidden"),document.getElementById("mainSection").classList.remove("hidden"),loadActive(),loadResults()):alert("T√™n kh√¥ng h·ª£p l·ªá!")}function logout(){listener&&listener.off(),localStorage.removeItem("teacher"),location.reload()}function createExam(){const e=document.getElementById("examTitle").value.trim(),t=parseInt(document.getElementById("duration").value),n=document.getElementById("latex").value.trim();if(!e||!n)return void alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß!");try{const i=parseLatex(n);0===i.length?alert("Kh√¥ng c√≥ c√¢u h·ªèi!"):(exam={title:e,duration:t,questions:i},showPreview(i))}catch(e){alert("L·ªói: "+e.message)}}function parseLatex(e){const t=[];return e.split("\\question").filter(e=>e.trim()).forEach((e,n)=>{const i=e.split("\n").map(e=>e.trim()).filter(e=>e);if(i.length){const e=i[0],s=[];let o=-1;i.slice(1).forEach(e=>{e.startsWith("\\choice")?s.push(e.replace("\\choice","").trim()):e.startsWith("\\CorrectChoice")&&(o=s.length,s.push(e.replace("\\CorrectChoice","").trim()))}),e&&s.length>0&&-1!==o&&t.push({id:n+1,question:e,choices:s,correctAnswer:o})}}),t}function showPreview(e){const t=document.getElementById("previewBox");t.innerHTML="",e.forEach((e,n)=>{const i=document.createElement("div");i.className="question-preview";let s=`<div class="question-text">C√¢u ${n+1}: ${e.question}</div>`;e.choices.forEach((t,n)=>{const i=n===e.correctAnswer;s+=`<div class="choice-item ${i?"correct-choice":"}">${String.fromCharCode(65+n)}. ${t} ${i?"‚úì":""}</div>`}),i.innerHTML=s,t.appendChild(i)}),document.getElementById("preview").classList.remove("hidden")}async function saveExam(){if(!exam)return;const e=Math.random().toString(36).substr(2,6).toUpperCase(),t={...exam,code:e,created:(new Date).toISOString(),teacher:localStorage.getItem("teacher"),active:!0};if(db)try{await db.ref("exams/"+e).set(t),alert("‚úÖ ƒê√£ l∆∞u!")}catch(e){return void alert("L·ªói: "+e.message)}else{const n=JSON.parse(localStorage.getItem("exams")||"{}");n[e]=t,localStorage.setItem("exams",JSON.stringify(n))}document.getElementById("code").textContent=e,document.getElementById("codeBox").classList.remove("hidden"),loadActive()}function copy(){const e=document.getElementById("code").textContent;navigator.clipboard.writeText(e).then(()=>alert("ƒê√£ copy: "+e))}async function loadActive(){const e=document.getElementById("activeList");if(db)db.ref("exams").orderByChild("active").equalTo(!0).once("value",t=>{displayActive(t.val()||{},e)});else{const t=JSON.parse(localStorage.getItem("exams")||"{}"),n={};Object.keys(t).forEach(e=>{t[e].active&&(n[e]=t[e])}),displayActive(n,e)}}function displayActive(e,t){if(0===Object.keys(e).length)return void(t.innerHTML='<p class="hint">Ch∆∞a c√≥ ƒë·ªÅ.</p>');let n='<table style="width:100%;border-collapse:collapse;"><tr style="background:#f8f9fa;"><th style="padding:10px;border:1px solid #ddd;">M√£</th><th style="padding:10px;border:1px solid #ddd;">T√™n</th><th style="padding:10px;border:1px solid #ddd;">Th·ªùi gian</th><th style="padding:10px;border:1px solid #ddd;">S·ªë c√¢u</th><th style="padding:10px;border:1px solid #ddd;">Thao t√°c</th></tr>';Object.keys(e).forEach(t=>{const i=e[t];n+=`<tr><td style="padding:10px;border:1px solid #ddd;"><strong>${t}</strong></td><td style="padding:10px;border:1px solid #ddd;">${i.title}</td><td style="padding:10px;border:1px solid #ddd;">${i.duration} ph√∫t</td><td style="padding:10px;border:1px solid #ddd;">${i.questions.length} c√¢u</td><td style="padding:10px;border:1px solid #ddd;"><button onclick="deactivate('${t}')" class="btn-delete">T·∫Øt</button></td></tr>`}),n+="</table>",t.innerHTML=n}async function deactivate(e){if(!confirm("T·∫Øt ƒë·ªÅ n√†y?"))return;if(db)await db.ref("exams/"+e+"/active").set(!1);else{const t=JSON.parse(localStorage.getItem("exams")||"{}");t[e]&&(t[e].active=!1),localStorage.setItem("exams",JSON.stringify(t))}loadActive(),alert("ƒê√£ t·∫Øt!")}function loadResults(){db?(listener=db.ref("results"),listener.on("value",e=>{results=Object.values(e.val()||{}),displayResults()})):(results=JSON.parse(localStorage.getItem("results")||"[]"),displayResults(),setInterval(()=>{results=JSON.parse(localStorage.getItem("results")||"[]"),displayResults()},5e3))}function displayResults(){const e=document.getElementById("resultsList");if(0===results.length)return void(e.innerHTML='<p class="hint">Ch∆∞a c√≥ k·∫øt qu·∫£.</p>');let t='<table style="width:100%;border-collapse:collapse;"><tr style="background:#f8f9fa;"><th style="padding:10px;border:1px solid #ddd;">T√™n</th><th style="padding:10px;border:1px solid #ddd;">M√£</th><th style="padding:10px;border:1px solid #ddd;">ƒêi·ªÉm</th><th style="padding:10px;border:1px solid #ddd;">Th·ªùi gian</th><th style="padding:10px;border:1px solid #ddd;">Tab</th><th style="padding:10px;border:1px solid #ddd;">X√≥a</th></tr>';results.forEach((e,n)=>{t+=`<tr><td style="padding:10px;border:1px solid #ddd;">${e.name}</td><td style="padding:10px;border:1px solid #ddd;">${e.code}</td><td style="padding:10px;border:1px solid #ddd;"><strong>${e.score}/10</strong></td><td style="padding:10px;border:1px solid #ddd;">${new Date(e.time).toLocaleString("vi-VN")}</td><td style="padding:10px;border:1px solid #ddd;">${e.tabSwitch?"‚ö†Ô∏è":"‚úì"}</td><td style="padding:10px;border:1px solid #ddd;"><button onclick="deleteResult('${e.id||n}')" class="btn-delete">üóëÔ∏è</button></td></tr>`}),t+="</table>",e.innerHTML=t}async function deleteResult(e){if(!confirm("X√≥a?"))return;db?await db.ref("results/"+e).remove():(results=results.filter((t,n)=>(t.id||n)!=e),localStorage.setItem("results",JSON.stringify(results)),displayResults())}async function clearResults(){if(!confirm("‚ö†Ô∏è X√ìA T·∫§T C·∫¢?"))return;if(!confirm("X√°c nh·∫≠n?"))return;db?await db.ref("results").remove():(localStorage.setItem("results","[]"),results=[],displayResults()),alert("ƒê√£ x√≥a!")}function refresh(){loadResults()}function downloadExcel(){if(0===results.length)return void alert("Kh√¥ng c√≥ k·∫øt qu·∫£!");const e=results.map((e,t)=>({STT:t+1,"H·ªç t√™n":e.name,"M√£ ƒë·ªÅ":e.code,"T√™n ƒë·ªÅ":e.examTitle||"",ƒêi·ªÉm:e.score,"S·ªë c√¢u ƒë√∫ng":e.correct||0,"T·ªïng c√¢u":e.total||0,"T·ª∑ l·ªá %":e.total?((e.correct/e.total)*100).toFixed(1):0,Tab:e.tabSwitch?"C√≥":"Kh√¥ng","Th·ªùi gian":new Date(e.time).toLocaleString("vi-VN")})),t=XLSX.utils.json_to_sheet(e);t["!cols"]=[{wch:5},{wch:25},{wch:12},{wch:30},{wch:8},{wch:12},{wch:12},{wch:10},{wch:12},{wch:20}];const n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,t,"K·∫øt Qu·∫£");const i=results.map(e=>e.score),s=XLSX.utils.json_to_sheet([{"Ch·ªâ s·ªë":"T·ªïng HS","Gi√° tr·ªã":results.length},{"Ch·ªâ s·ªë":"ƒêi·ªÉm TB","Gi√° tr·ªã":(i.reduce((e,t)=>e+t,0)/i.length).toFixed(2)},{"Ch·ªâ s·ªë":"Cao nh·∫•t","Gi√° tr·ªã":Math.max(...i).toFixed(1)},{"Ch·ªâ s·ªë":"Th·∫•p nh·∫•t","Gi√° tr·ªã":Math.min(...i).toFixed(1)},{"Ch·ªâ s·ªë":"Gi·ªèi","Gi√° tr·ªã":i.filter(e=>e>=8).length},{"Ch·ªâ s·ªë":"Kh√°","Gi√° tr·ªã":i.filter(e=>e>=6.5).length},{"Ch·ªâ s·ªë":"TB","Gi√° tr·ªã":i.filter(e=>e>=5).length},{"Ch·ªâ s·ªë":"Y·∫øu","Gi√° tr·ªã":i.filter(e=>e<5).length},{"Ch·ªâ s·ªë":"Chuy·ªÉn tab","Gi√° tr·ªã":results.filter(e=>e.tabSwitch).length}]);s["!cols"]=[{wch:20},{wch:15}],XLSX.utils.book_append_sheet(n,s,"Th·ªëng K√™");const o=new Date,a=`KetQua_${o.getFullYear()}${String(o.getMonth()+1).padStart(2,"0")}${String(o.getDate()).padStart(2,"0")}_${String(o.getHours()).padStart(2,"0")}${String(o.getMinutes()).padStart(2,"0")}.xlsx`;XLSX.writeFile(n,a),alert("‚úÖ ƒê√£ t·∫£i: "+a)}window.addEventListener("load",()=>{const e=localStorage.getItem("fbConfig");if(e)try{const t=JSON.parse(e);firebase.apps.length||firebase.initializeApp(t),db=firebase.database(),document.getElementById("configSection").classList.add("hidden"),db.ref(".info/connected").on("value",e=>{updateStatus(e.val())});const n=localStorage.getItem("teacher");n?(document.getElementById("loginSection").classList.add("hidden"),document.getElementById("mainSection").classList.remove("hidden"),loadActive(),loadResults()):document.getElementById("loginSection").classList.remove("hidden")}catch(e){console.error(e)}});

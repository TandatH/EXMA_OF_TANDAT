<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Sinh - Firebase</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div id="loginSection" class="card">
            <h1>ƒêƒÉng Nh·∫≠p H·ªçc Sinh</h1>
            <div id="status" class="hint">‚è≥ ƒêang k·∫øt n·ªëi...</div>
            <input type="text" id="name" placeholder="H·ªç t√™n" class="input-field">
            <input type="text" id="code" placeholder="M√£ ƒë·ªÅ thi" class="input-field">
            <button onclick="login()" class="btn btn-primary">ƒêƒÉng Nh·∫≠p</button>
        </div>

        <div id="waitingSection" class="card hidden">
            <h1 id="welcome">Ch√†o m·ª´ng!</h1>
            <div class="exam-info">
                <h2 id="title"></h2>
                <p>Th·ªùi gian: <strong id="duration"></strong> ph√∫t</p>
                <p>S·ªë c√¢u: <strong id="count"></strong></p>
            </div>
            <button onclick="start()" class="btn btn-success btn-large">B·∫Øt ƒê·∫ßu</button>
        </div>

        <div id="examSection" class="card hidden">
            <div class="exam-header">
                <h2 id="titleTop"></h2>
                <div class="timer-display">‚è±Ô∏è <span id="timer" class="timer">00:00</span></div>
            </div>
            <div id="warning" class="warning-box hidden">‚ö†Ô∏è KH√îNG CHUY·ªÇN TAB!</div>
            <div id="questions"></div>
            <button onclick="submit()" class="btn btn-primary btn-large">N·ªôp B√†i</button>
        </div>

        <div id="resultSection" class="card hidden">
            <h1>K·∫øt Qu·∫£</h1>
            <div class="result-display">
                <div class="score-circle">
                    <span id="score" class="score-number">0</span>
                    <span class="score-label">/10</span>
                </div>
                <p>H·ªç t√™n: <strong id="resultName"></strong></p>
                <p>ƒê√∫ng: <strong id="correct"></strong>/<strong id="total"></strong></p>
                <p id="msg" class="status-message"></p>
            </div>
            <div id="details" class="detailed-results"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        // ==========================================
        // 1. ƒêI·ªÄN TH√îNG TIN C·ª¶A B·∫†N V√ÄO ƒê√ÇY (QUAN TR·ªåNG)
        // ==========================================
        const config = {
            apiKey: "AIzaSyADniEL6bbqGpa1a4O_k1Q0w5GRW5cfWjY",        // V√≠ d·ª•: "AIzaSyD..."
            databaseURL: "https://exam-project-4ef04-default-rtdb.firebaseio.com",     // V√≠ d·ª•: "https://...firebaseio.com"
            projectId: exam-project-4ef04"           // V√≠ d·ª•: "exam-system-123"
        };
        // ==========================================

        let db = null;
        let examData = null;
        let studentName = "";
        let examCode = "";
        let timerInterval = null;
        let userAnswers = {};

        // T·ª∞ ƒê·ªòNG K·∫æT N·ªêI NGAY KHI M·ªû TRANG
        try {
            // X·ª≠ l√Ω link database n·∫øu th·ª´a d·∫•u /
            if (config.databaseURL.endsWith("/")) config.databaseURL = config.databaseURL.slice(0, -1);
            
            // Th√™m authDomain ƒë·ªÉ tr√°nh l·ªói
            config.authDomain = config.projectId + ".firebaseapp.com";

            if (!firebase.apps.length) firebase.initializeApp(config);
            db = firebase.database();
            
            // Ki·ªÉm tra k·∫øt n·ªëi
            const statusNode = document.getElementById("status");
            db.ref(".info/connected").on("value", (snap) => {
                if (snap.val() === true) {
                    if(statusNode) statusNode.textContent = "üü¢ ƒê√£ k·∫øt n·ªëi m√°y ch·ªß";
                } else {
                    if(statusNode) statusNode.textContent = "‚è≥ ƒêang d√≤ t√¨m m√°y ch·ªß...";
                }
            });

        } catch (e) {
            alert("L·ªói C·∫•u H√¨nh: " + e.message);
        }

        // --- CH·ª®C NƒÇNG 1: ƒêƒÇNG NH·∫¨P ---
        async function login() {
            studentName = document.getElementById("name").value.trim();
            examCode = document.getElementById("code").value.trim().toUpperCase(); // T·ª± vi·∫øt hoa m√£

            if (!studentName || !examCode) {
                return alert("Vui l√≤ng nh·∫≠p T√™n v√† M√£ ƒë·ªÅ thi!");
            }

            // T√¨m ƒë·ªÅ thi tr√™n Firebase
            try {
                const snapshot = await db.ref("exams/" + examCode).once("value");
                const data = snapshot.val();

                if (!data) {
                    alert("‚ùå M√£ ƒë·ªÅ thi kh√¥ng t·ªìn t·∫°i!");
                    return;
                }

                if (!data.active) {
                    alert("‚õî ƒê·ªÅ thi n√†y ƒë√£ b·ªã Gi√°o vi√™n ƒë√≥ng!");
                    return;
                }

                // Th√†nh c√¥ng -> Hi·ªán th√¥ng tin ƒë·ªÅ
                examData = data;
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("waitingSection").classList.remove("hidden");
                
                document.getElementById("welcome").textContent = "Ch√†o " + studentName + "!";
                document.getElementById("title").textContent = data.title;
                document.getElementById("duration").textContent = data.duration;
                document.getElementById("count").textContent = data.questions.length + " c√¢u";

            } catch (error) {
                alert("L·ªói ƒëƒÉng nh·∫≠p: " + error.message);
            }
        }

        // --- CH·ª®C NƒÇNG 2: B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI ---
        function start() {
            document.getElementById("waitingSection").classList.add("hidden");
            document.getElementById("examSection").classList.remove("hidden");
            document.getElementById("titleTop").textContent = examData.title;

            // Hi·ªÉn th·ªã c√¢u h·ªèi
            renderQuestions();

            // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c
            let timeLeft = examData.duration * 60; // ƒê·ªïi ra gi√¢y
            updateTimerDisplay(timeLeft);

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("‚è∞ H·∫æT GI·ªú! H·ªá th·ªëng s·∫Ω t·ª± n·ªôp b√†i.");
                    submit(true); // true = n·ªôp do h·∫øt gi·ªù
                }
            }, 1000);

            // B·∫Øt s·ª± ki·ªán chuy·ªÉn Tab (Ch·ªëng gian l·∫≠n)
            document.addEventListener("visibilitychange", () => {
                if (document.hidden) {
                    document.getElementById("warning").classList.remove("hidden");
                    // B·∫°n c√≥ th·ªÉ b·ªè comment d√≤ng d∆∞·ªõi n·∫øu mu·ªën n·ªôp b√†i lu√¥n khi chuy·ªÉn tab
                    // submit(true); 
                }
            });
        }

        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById("timer").textContent = `${m}:${s}`;
        }

        function renderQuestions() {
            const container = document.getElementById("questions");
            container.innerHTML = "";

            examData.questions.forEach((q, index) => {
                // T·∫°o khung c√¢u h·ªèi
                const div = document.createElement("div");
                div.className = "question-box"; // CSS class gi·∫£ ƒë·ªãnh
                div.style.marginBottom = "20px";
                div.style.padding = "15px";
                div.style.background = "#f9f9f9";
                div.style.borderRadius = "8px";

                let html = `<div><strong>C√¢u ${index + 1}:</strong> ${q.question}</div>`;
                
                // T·∫°o c√°c l·ª±a ch·ªçn
                q.choices.forEach((choice, cIndex) => {
                    const choiceId = `q${index}_c${cIndex}`;
                    html += `
                        <div style="margin-top: 8px;">
                            <input type="radio" name="q${index}" id="${choiceId}" value="${cIndex}" onchange="selectAnswer(${index}, ${cIndex})">
                            <label for="${choiceId}" style="cursor:pointer; margin-left: 5px;">
                                ${String.fromCharCode(65 + cIndex)}. ${choice}
                            </label>
                        </div>
                    `;
                });

                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        function selectAnswer(qIndex, cIndex) {
            userAnswers[qIndex] = cIndex;
        }

        // --- CH·ª®C NƒÇNG 3: N·ªòP B√ÄI ---
        async function submit(autoSubmit = false) {
            if (!autoSubmit && !confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?")) return;

            clearInterval(timerInterval);

            // T√≠nh ƒëi·ªÉm
            let correctCount = 0;
            examData.questions.forEach((q, index) => {
                if (userAnswers[index] === q.correctAnswer) {
                    correctCount++;
                }
            });

            const total = examData.questions.length;
            const score = (correctCount / total * 10).toFixed(1);

            // G·ª≠i k·∫øt qu·∫£ l√™n Firebase
            const resultData = {
                name: studentName,
                code: examCode,
                score: score,
                correct: correctCount,
                total: total,
                examTitle: examData.title,
                time: Date.now(),
                tabSwitch: !document.getElementById("warning").classList.contains("hidden")
            };

            await db.ref("results").push(resultData);

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            document.getElementById("examSection").classList.add("hidden");
            document.getElementById("resultSection").classList.remove("hidden");
            
            document.getElementById("score").textContent = score;
            document.getElementById("resultName").textContent = studentName;
            document.getElementById("correct").textContent = correctCount;
            document.getElementById("total").textContent = total;
            document.getElementById("msg").textContent = autoSubmit ? "‚ö†Ô∏è ƒê√£ t·ª± ƒë·ªông n·ªôp b√†i!" : "‚úÖ N·ªôp b√†i th√†nh c√¥ng!";
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Sinh - L√†m B√†i Thi</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* CSS C∆† B·∫¢N */
        .hidden { display: none !important; }
        .card { max-width: 700px; margin: 20px auto; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .input-field { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        
        /* C√ÇU H·ªéI */
        .question-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff; }
        .question-text { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
        .choice-label { display: block; padding: 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s; }
        .choice-label:hover { background: #e9ecef; }
        input[type="radio"] { margin-right: 10px; transform: scale(1.2); }

        /* ƒê·ªíNG H·ªí & TR·∫†NG TH√ÅI */
        .exam-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .timer { font-size: 24px; font-weight: bold; color: #dc3545; background: #fff0f0; padding: 5px 15px; border-radius: 20px; }
        
        /* C·∫¢NH B√ÅO GIAN L·∫¨N (MODAL) */
        #cheatModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(220, 53, 69, 0.95); /* M√†u ƒë·ªè ƒë·∫≠m */
            color: white; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        #cheatModal h1 { font-size: 40px; margin-bottom: 20px; }
        #cheatModal p { font-size: 20px; }
        #cheatModal button { background: white; color: red; border: none; padding: 15px 30px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 50px; margin-top: 30px; }

        /* K·∫æT QU·∫¢ */
        .score-circle { width: 120px; height: 120px; background: #28a745; color: white; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 0 auto 20px; }
        .score-number { font-size: 40px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="cheatModal" class="hidden">
        <h1>‚ö†Ô∏è C·∫¢NH B√ÅO VI PH·∫†M!</h1>
        <p>H·ªá th·ªëng ph√°t hi·ªán b·∫°n v·ª´a r·ªùi kh·ªèi m√†n h√¨nh l√†m b√†i.</p>
        <p>H√†nh ƒë·ªông n√†y ƒë√£ b·ªã ghi l·∫°i v√† b√°o c√°o cho Gi√°o vi√™n.</p>
        <p>N·∫øu ti·∫øp t·ª•c, b√†i thi s·∫Ω b·ªã h·ªßy.</p>
        <button onclick="closeCheatModal()">T√îI ƒê√É HI·ªÇU, QUAY L·∫†I L√ÄM B√ÄI</button>
    </div>

    <div class="container">
        
        <div id="loginSection" class="card">
            <h2 style="text-align: center;">ƒêƒÉng Nh·∫≠p Thi</h2>
            <p id="status" style="text-align: center; color: #666;">‚è≥ ƒêang k·∫øt n·ªëi m√°y ch·ªß...</p>
            
            <label>H·ªç v√† T√™n:</label>
            <input type="text" id="name" class="input-field" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
            
            <label>M√£ ƒê·ªÅ Thi:</label>
            <input type="text" id="code" class="input-field" placeholder="Nh·∫≠p m√£ do GV cung c·∫•p (VD: X8K2MN)">
            
            <button onclick="login()" class="btn btn-primary">V√ÄO PH√íNG THI</button>
        </div>

        <div id="waitingSection" class="card hidden" style="text-align: center;">
            <h1>üëã Xin ch√†o, <span id="welcomeName" style="color: #007bff;"></span></h1>
            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h2 id="examTitle">T√™n ƒê·ªÅ Thi</h2>
                <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                    <div>‚è±Ô∏è <strong><span id="examDuration">0</span></strong> ph√∫t</div>
                    <div>üìù <strong><span id="examQCount">0</span></strong> c√¢u h·ªèi</div>
                </div>
            </div>
            <p style="color: red; font-style: italic;">‚ö†Ô∏è L∆∞u √Ω: Tuy·ªát ƒë·ªëi kh√¥ng chuy·ªÉn tab ho·∫∑c m·ªü ·ª©ng d·ª•ng kh√°c. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ph√°t hi·ªán gian l·∫≠n.</p>
            <button onclick="startExam()" class="btn btn-success">B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI NGAY</button>
        </div>

        <div id="examSection" class="card hidden">
            <div class="exam-header">
                <div style="font-weight: bold;">Th√≠ sinh: <span id="studentDisplay"></span></div>
                <div class="timer" id="timer">00:00</div>
            </div>

            <div id="questionsList">
                </div>

            <button onclick="submitExam()" class="btn btn-primary">N·ªòP B√ÄI THI</button>
        </div>

        <div id="resultSection" class="card hidden" style="text-align: center;">
            <h2>K·∫æT QU·∫¢ B√ÄI THI</h2>
            <div class="score-circle">
                <span id="scoreVal" class="score-number">0</span>
                <span>ƒêi·ªÉm</span>
            </div>
            <h3 id="resultMsg"></h3>
            <p>S·ªë c√¢u ƒë√∫ng: <strong id="correctCount">0</strong> / <strong id="totalCount">0</strong></p>
            <div id="cheatWarning" class="hidden" style="margin-top: 15px; padding: 10px; background: #ffebee; color: red; border: 1px solid red; border-radius: 5px;">
                ‚ö†Ô∏è PH√ÅT HI·ªÜN GIAN L·∫¨N: <strong id="cheatCount">0</strong> L·∫¶N CHUY·ªÇN TAB
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ============================================================
        // üî¥ ƒêI·ªÄN TH√îNG TIN FIREBASE C·ª¶A B·∫†N V√ÄO ƒê√ÇY:
        // ============================================================
        const config = {
            apiKey: "AIzaSyADniEL6bbqGpa1a4O_k1Q0w5GRW5cfWjY", 
            databaseURL: "https://exam-project-4ef04-default-rtdb.firebaseio.com", 
            projectId: "exam-project-4ef04"
        };
        // ============================================================

        let db = null;
        let examData = null;
        let studentName = "";
        let examCode = "";
        let timerInterval = null;
        let userAnswers = {};
        let violationCount = 0; // ƒê·∫øm s·ªë l·∫ßn gian l·∫≠n

        // 1. T·ª∞ ƒê·ªòNG K·∫æT N·ªêI
        window.onload = function() {
            try {
                if (config.databaseURL.endsWith("/")) config.databaseURL = config.databaseURL.slice(0, -1);
                config.authDomain = config.projectId + ".firebaseapp.com";

                if (!firebase.apps.length) firebase.initializeApp(config);
                db = firebase.database();

                const st = document.getElementById("status");
                db.ref(".info/connected").on("value", snap => {
                    if(snap.val()) {
                        st.innerHTML = "üü¢ <strong>ƒê√£ k·∫øt n·ªëi m√°y ch·ªß thi</strong>";
                        st.style.color = "green";
                    } else {
                        st.textContent = "üî¥ M·∫•t k·∫øt n·ªëi m·∫°ng...";
                        st.style.color = "red";
                    }
                });
            } catch (e) {
                alert("‚ö†Ô∏è L·ªói c·∫•u h√¨nh: Ch∆∞a ƒëi·ªÅn API Key v√†o code!");
            }
        };

        // 2. ƒêƒÇNG NH·∫¨P
        async function login() {
            studentName = document.getElementById("name").value.trim();
            examCode = document.getElementById("code").value.trim().toUpperCase();

            if (!studentName || !examCode) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");

            try {
                const snap = await db.ref("exams/" + examCode).once("value");
                const data = snap.val();

                if (!data) return alert("‚ùå M√£ ƒë·ªÅ thi kh√¥ng t·ªìn t·∫°i!");
                if (!data.active) return alert("‚õî ƒê·ªÅ thi n√†y ƒë√£ ƒë√≥ng!");

                examData = data;
                
                // Chuy·ªÉn m√†n h√¨nh
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("waitingSection").classList.remove("hidden");
                
                // ƒêi·ªÅn th√¥ng tin
                document.getElementById("welcomeName").textContent = studentName;
                document.getElementById("examTitle").textContent = data.title;
                document.getElementById("examDuration").textContent = data.duration;
                document.getElementById("examQCount").textContent = data.questions.length;

            } catch (e) {
                alert("L·ªói: " + e.message);
            }
        }

        // 3. B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI
        function startExam() {
            // Y√™u c·∫ßu full screen (T√πy tr√¨nh duy·ªát c√≥ cho ph√©p kh√¥ng)
            try {
                if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            } catch (e) { console.log("Kh√¥ng th·ªÉ full screen"); }

            document.getElementById("waitingSection").classList.add("hidden");
            document.getElementById("examSection").classList.remove("hidden");
            document.getElementById("studentDisplay").textContent = studentName;

            renderQuestions();
            startTimer(examData.duration * 60);
            
            // K√çCH HO·∫†T CH·∫æ ƒê·ªò CH·ªêNG GIAN L·∫¨N
            enableAntiCheat();
        }

        function renderQuestions() {
            const list = document.getElementById("questionsList");
            list.innerHTML = "";
            
            examData.questions.forEach((q, index) => {
                let html = `
                    <div class="question-box">
                        <div class="question-text">C√¢u ${index + 1}: ${q.question}</div>
                `;
                q.choices.forEach((choice, cIndex) => {
                    html += `
                        <label class="choice-label">
                            <input type="radio" name="q${index}" value="${cIndex}" onchange="userAnswers[${index}]=${cIndex}">
                            <span>${String.fromCharCode(65 + cIndex)}. ${choice}</span>
                        </label>
                    `;
                });
                list.innerHTML += html + "</div>";
            });
        }

        function startTimer(seconds) {
            updateTimerUI(seconds);
            timerInterval = setInterval(() => {
                seconds--;
                updateTimerUI(seconds);
                if (seconds <= 0) {
                    clearInterval(timerInterval);
                    alert("‚è∞ H·∫æT GI·ªú! H·ªá th·ªëng s·∫Ω t·ª± n·ªôp b√†i.");
                    submitExam(true);
                }
            }, 1000);
        }

        function updateTimerUI(s) {
            const min = Math.floor(s / 60).toString().padStart(2, '0');
            const sec = (s % 60).toString().padStart(2, '0');
            const timerEl = document.getElementById("timer");
            timerEl.textContent = `${min}:${sec}`;
            
            // ƒê·ªïi m√†u khi s·∫Øp h·∫øt gi·ªù
            if(s < 60) { timerEl.style.background = "red"; timerEl.style.color = "white"; }
        }

        // --- CH·ªêNG GIAN L·∫¨N (QUAN TR·ªåNG) ---
        function enableAntiCheat() {
            document.addEventListener("visibilitychange", () => {
                // N·∫øu tab b·ªã ·∫©n (ng∆∞·ªùi d√πng chuy·ªÉn tab ho·∫∑c minimize)
                if (document.hidden) {
                    violationCount++; // TƒÉng s·ªë l·∫ßn vi ph·∫°m
                    document.title = "‚ö†Ô∏è QUAY L·∫†I NGAY!"; // ƒê·ªïi t√™n tab
                    document.getElementById("cheatModal").classList.remove("hidden"); // Hi·ªán m√†n h√¨nh ƒë·ªè
                } else {
                    document.title = "L√†m B√†i Thi";
                }
            });
            
            // Ch·∫∑n chu·ªôt ph·∫£i (ƒë·ªÉ h·∫°n ch·∫ø copy)
            document.addEventListener('contextmenu', event => event.preventDefault());
        }

        function closeCheatModal() {
            document.getElementById("cheatModal").classList.add("hidden");
        }

        // 4. N·ªòP B√ÄI
        async function submitExam(auto = false) {
            if (!auto && !confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?")) return;
            clearInterval(timerInterval);

            // T√≠nh ƒëi·ªÉm
            let correct = 0;
            examData.questions.forEach((q, i) => {
                if (userAnswers[i] === q.correctAnswer) correct++;
            });
            
            const total = examData.questions.length;
            const score = (correct / total * 10).toFixed(1);
            const isCheated = violationCount > 0;

            // G·ª≠i k·∫øt qu·∫£
            const resultData = {
                name: studentName,
                code: examCode,
                score: score,
                correct: correct,
                total: total,
                timestamp: Date.now(),
                tabSwitch: isCheated, // G·ª≠i c·ªù b√°o gian l·∫≠n
                violationCount: violationCount // G·ª≠i s·ªë l·∫ßn vi ph·∫°m
            };

            await db.ref("results").push(resultData);

            // Hi·ªán k·∫øt qu·∫£
            document.getElementById("examSection").classList.add("hidden");
            document.getElementById("resultSection").classList.remove("hidden");
            document.getElementById("scoreVal").textContent = score;
            document.getElementById("correctCount").textContent = correct;
            document.getElementById("totalCount").textContent = total;
            document.getElementById("resultMsg").textContent = auto ? "H·∫øt gi·ªù l√†m b√†i!" : "N·ªôp b√†i th√†nh c√¥ng!";

            // N·∫øu c√≥ gian l·∫≠n th√¨ hi·ªán c·∫£nh b√°o ·ªü k·∫øt qu·∫£
            if (isCheated) {
                const w = document.getElementById("cheatWarning");
                w.classList.remove("hidden");
                document.getElementById("cheatCount").textContent = violationCount;
            }
        }
    </script>
</body>
</html>

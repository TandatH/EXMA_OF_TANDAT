<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Sinh - L√†m B√†i Thi</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* CSS C∆† B·∫¢N */
        .hidden { display: none !important; }
        .card { max-width: 700px; margin: 20px auto; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .input-field { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        
        /* C√ÇU H·ªéI */
        .question-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff; }
        .question-text { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
        .choice-label { display: block; padding: 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s; }
        .choice-label:hover { background: #e9ecef; }
        input[type="radio"] { margin-right: 10px; transform: scale(1.2); }

        /* ƒê·ªíNG H·ªí */
        .exam-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .timer { font-size: 24px; font-weight: bold; color: #dc3545; background: #fff0f0; padding: 5px 15px; border-radius: 20px; }
        
        /* K·∫æT QU·∫¢ */
        .score-circle { width: 120px; height: 120px; background: #28a745; color: white; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 0 auto 20px; }
        .score-number { font-size: 40px; font-weight: bold; }
        .cheat-alert { background: #ffebee; color: #c62828; padding: 15px; border: 2px solid #c62828; border-radius: 8px; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="loginSection" class="card">
            <h2 style="text-align: center;">ƒêƒÉng Nh·∫≠p Thi</h2>
            <p id="status" style="text-align: center; color: #666;">‚è≥ ƒêang k·∫øt n·ªëi m√°y ch·ªß...</p>
            
            <label>H·ªç v√† T√™n:</label>
            <input type="text" id="name" class="input-field" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
            
            <label>M√£ ƒê·ªÅ Thi:</label>
            <input type="text" id="code" class="input-field" placeholder="Nh·∫≠p m√£ (VD: X8K2MN)">
            
            <button onclick="login()" class="btn btn-primary">V√ÄO PH√íNG THI</button>
        </div>

        <div id="waitingSection" class="card hidden" style="text-align: center;">
            <h1>üëã Xin ch√†o, <span id="welcomeName" style="color: #007bff;"></span></h1>
            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h2 id="examTitle">T√™n ƒê·ªÅ Thi</h2>
                <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                    <div>‚è±Ô∏è <strong><span id="examDuration">0</span></strong> ph√∫t</div>
                    <div>üìù <strong><span id="examQCount">0</span></strong> c√¢u h·ªèi</div>
                </div>
            </div>
            
            <div style="text-align: left; background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba;">
                <h3 style="color: #856404; margin-top: 0;">‚ö†Ô∏è QUY ƒê·ªäNH NGHI√äM NG·∫∂T:</h3>
                <ul style="padding-left: 20px; color: #856404;">
                    <li>Kh√¥ng ƒë∆∞·ª£c chuy·ªÉn Tab tr√¨nh duy·ªát.</li>
                    <li>Kh√¥ng ƒë∆∞·ª£c m·ªü c·ª≠a s·ªï ·ª©ng d·ª•ng kh√°c.</li>
                    <li>Kh√¥ng ƒë∆∞·ª£c thu nh·ªè m√†n h√¨nh.</li>
                    <li><strong>VI PH·∫†M S·∫º B·ªä THU B√ÄI NGAY L·∫¨P T·ª®C!</strong></li>
                </ul>
            </div>
            <br>
            <button onclick="startExam()" class="btn btn-success">T√îI ƒê√É HI·ªÇU - B·∫ÆT ƒê·∫¶U L√ÄM</button>
        </div>

        <div id="examSection" class="card hidden">
            <div class="exam-header">
                <div style="font-weight: bold;">Th√≠ sinh: <span id="studentDisplay"></span></div>
                <div class="timer" id="timer">00:00</div>
            </div>

            <div id="questionsList"></div>

            <button onclick="submitExam(false)" class="btn btn-primary">N·ªòP B√ÄI THI</button>
        </div>

        <div id="resultSection" class="card hidden" style="text-align: center;">
            <h2 id="resultTitle">K·∫æT QU·∫¢ B√ÄI THI</h2>
            
            <div id="cheatBox" class="cheat-alert hidden">
                ‚õî B√ÄI THI ƒê√É B·ªä D·ª™NG!<br>
                H·ªá th·ªëng ph√°t hi·ªán b·∫°n ƒë√£ r·ªùi kh·ªèi m√†n h√¨nh thi.
            </div>

            <div class="score-circle" id="scoreCircle">
                <span id="scoreVal" class="score-number">0</span>
                <span>ƒêi·ªÉm</span>
            </div>
            
            <p>S·ªë c√¢u ƒë√∫ng: <strong id="correctCount">0</strong> / <strong id="totalCount">0</strong></p>
            <p id="resultMsg" style="font-style: italic; color: #555;"></p>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ============================================================
        // üî¥ ƒêI·ªÄN TH√îNG TIN FIREBASE C·ª¶A B·∫†N V√ÄO ƒê√ÇY:
        // ============================================================
        const config = {
            apiKey: "AIzaSyADniEL6bbqGpa1a4O_k1Q0w5GRW5cfWjY", 
            databaseURL: "https://exam-project-4ef04-default-rtdb.firebaseio.com", 
            projectId: "exam-project-4ef04"
        };
        // ============================================================

        let db = null;
        let examData = null;
        let studentName = "";
        let examCode = "";
        let timerInterval = null;
        let userAnswers = {};
        let isExamRunning = false; // Bi·∫øn ki·ªÉm so√°t tr·∫°ng th√°i thi

        // 1. T·ª∞ ƒê·ªòNG K·∫æT N·ªêI
        window.onload = function() {
            try {
                if (config.databaseURL.endsWith("/")) config.databaseURL = config.databaseURL.slice(0, -1);
                config.authDomain = config.projectId + ".firebaseapp.com";
                if (!firebase.apps.length) firebase.initializeApp(config);
                db = firebase.database();

                db.ref(".info/connected").on("value", snap => {
                    const st = document.getElementById("status");
                    if(snap.val()) {
                        st.innerHTML = "üü¢ <strong>ƒê√£ k·∫øt n·ªëi h·ªá th·ªëng</strong>";
                        st.style.color = "green";
                    } else {
                        st.innerHTML = "üî¥ M·∫•t k·∫øt n·ªëi m·∫°ng...";
                        st.style.color = "red";
                    }
                });
            } catch (e) { alert("‚ö†Ô∏è L·ªói config: Ch∆∞a nh·∫≠p API Key!"); }
        };

        // 2. ƒêƒÇNG NH·∫¨P
        async function login() {
            studentName = document.getElementById("name").value.trim();
            examCode = document.getElementById("code").value.trim().toUpperCase();

            if (!studentName || !examCode) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");

            try {
                const snap = await db.ref("exams/" + examCode).once("value");
                const data = snap.val();

                if (!data) return alert("‚ùå M√£ ƒë·ªÅ kh√¥ng ƒë√∫ng!");
                if (!data.active) return alert("‚õî ƒê·ªÅ thi ƒë√£ ƒë√≥ng!");

                examData = data;
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("waitingSection").classList.remove("hidden");
                
                document.getElementById("welcomeName").textContent = studentName;
                document.getElementById("examTitle").textContent = data.title;
                document.getElementById("examDuration").textContent = data.duration;
                document.getElementById("examQCount").textContent = data.questions.length;

            } catch (e) { alert("L·ªói: " + e.message); }
        }

        // 3. B·∫ÆT ƒê·∫¶U THI
        function startExam() {
            // Y√™u c·∫ßu Fullscreen ƒë·ªÉ t·∫≠p trung
            try { if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen(); } catch(e){}

            document.getElementById("waitingSection").classList.add("hidden");
            document.getElementById("examSection").classList.remove("hidden");
            document.getElementById("studentDisplay").textContent = studentName;

            renderQuestions();
            startTimer(examData.duration * 60);
            
            // B·∫¨T C·ªú ƒêANG THI -> K√≠ch ho·∫°t Anti-Cheat
            isExamRunning = true;
            setupAntiCheat();
        }

        function renderQuestions() {
            const list = document.getElementById("questionsList");
            list.innerHTML = "";
            examData.questions.forEach((q, index) => {
                let html = `<div class="question-box"><div class="question-text">C√¢u ${index + 1}: ${q.question}</div>`;
                q.choices.forEach((choice, cIndex) => {
                    html += `<label class="choice-label"><input type="radio" name="q${index}" onchange="userAnswers[${index}]=${cIndex}"> ${String.fromCharCode(65 + cIndex)}. ${choice}</label>`;
                });
                list.innerHTML += html + "</div>";
            });
        }

        function startTimer(seconds) {
            updateTimerUI(seconds);
            timerInterval = setInterval(() => {
                seconds--;
                updateTimerUI(seconds);
                if (seconds <= 0) {
                    clearInterval(timerInterval);
                    alert("‚è∞ H·∫æT GI·ªú!");
                    submitExam(false, "timeout"); 
                }
            }, 1000);
        }

        function updateTimerUI(s) {
            const m = Math.floor(s / 60).toString().padStart(2,'0');
            const sec = (s % 60).toString().padStart(2,'0');
            document.getElementById("timer").textContent = `${m}:${sec}`;
        }

        // --- üíÄ ANTI-CHEAT: CHUY·ªÇN TAB L√Ä CH·∫æT ---
        function setupAntiCheat() {
            document.addEventListener("visibilitychange", () => {
                // Ch·ªâ x·ª≠ l√Ω n·∫øu ƒëang trong gi·ªù l√†m b√†i
                if (document.hidden && isExamRunning) {
                    // N·ªòP B√ÄI NGAY L·∫¨P T·ª®C V·ªöI L√ù DO 'CHEAT'
                    submitExam(true, "cheat");
                }
            });
            
            // Ch·∫∑n chu·ªôt ph·∫£i
            document.addEventListener('contextmenu', event => event.preventDefault());
        }

        // 4. N·ªòP B√ÄI
        async function submitExam(auto = false, reason = "normal") {
            if (!auto && !confirm("N·ªôp b√†i ngay?")) return;

            // Ng·∫Øt tr·∫°ng th√°i thi ngay l·∫≠p t·ª©c ƒë·ªÉ kh√¥ng b·ªã trigger loop
            isExamRunning = false; 
            clearInterval(timerInterval);

            // T√≠nh ƒëi·ªÉm
            let correct = 0;
            examData.questions.forEach((q, i) => { if (userAnswers[i] === q.correctAnswer) correct++; });
            const total = examData.questions.length;
            const score = (correct / total * 10).toFixed(1);

            // G·ª≠i d·ªØ li·ªáu
            const resultData = {
                name: studentName,
                code: examCode,
                score: score,
                correct: correct,
                total: total,
                timestamp: Date.now(),
                // N·∫øu reason l√† cheat th√¨ ƒë√°nh d·∫•u tabSwitch = true
                tabSwitch: (reason === "cheat") 
            };

            await db.ref("results").push(resultData);

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            document.getElementById("examSection").classList.add("hidden");
            document.getElementById("resultSection").classList.remove("hidden");
            
            document.getElementById("scoreVal").textContent = score;
            document.getElementById("correctCount").textContent = correct;
            document.getElementById("totalCount").textContent = total;

            // X·ª≠ l√Ω th√¥ng b√°o d·ª±a tr√™n l√Ω do n·ªôp
            const msgNode = document.getElementById("resultMsg");
            const cheatBox = document.getElementById("cheatBox");
            const circle = document.getElementById("scoreCircle");

            if (reason === "cheat") {
                cheatBox.classList.remove("hidden");
                msgNode.textContent = "B·∫°n ƒë√£ vi ph·∫°m quy ch·∫ø thi (R·ªùi m√†n h√¨nh).";
                circle.style.background = "#dc3545"; // ƒê·ªïi m√†u ƒë·ªè
            } else if (reason === "timeout") {
                msgNode.textContent = "ƒê√£ t·ª± ƒë·ªông n·ªôp b√†i do h·∫øt gi·ªù.";
            } else {
                msgNode.textContent = "B·∫°n ƒë√£ n·ªôp b√†i th√†nh c√¥ng.";
            }
        }
    </script>
</body>
</html>

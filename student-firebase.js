// STUDENT-FIREBASE.JS
let db=null,exam=null,name="",code="",answers={},startTime=null,timer=null,tabSwitch=!1,submitted=!1;function initFirebase(){const e=localStorage.getItem("fbConfig");if(e)try{const t=JSON.parse(e);return firebase.apps.length||firebase.initializeApp(t),db=firebase.database(),updateStatus(!0),db.ref(".info/connected").on("value",e=>{updateStatus(e.val())}),!0}catch(e){return console.error(e),!1}return!1}function updateStatus(e){const t=document.getElementById("status");t&&(t.textContent=e?"üü¢ ƒê√£ k·∫øt n·ªëi":"üî¥ M·∫•t k·∫øt n·ªëi")}async function login(){const e=document.getElementById("name").value.trim(),t=document.getElementById("code").value.trim().toUpperCase();if(!e)return void alert("Vui l√≤ng nh·∫≠p t√™n!");if(!t)return void alert("Vui l√≤ng nh·∫≠p m√£!");if(name=e,code=t,db)try{const e=await db.ref("exams/"+t).once("value"),n=e.val();if(!n)return void alert("M√£ kh√¥ng h·ª£p l·ªá!");if(!n.active)return void alert("ƒê·ªÅ thi ƒë√£ b·ªã t·∫Øt!");exam=n,showWaiting()}catch(e){alert("L·ªói: "+e.message)}else{const e=JSON.parse(localStorage.getItem("exams")||"{}");if(!e[t])return void alert("M√£ kh√¥ng h·ª£p l·ªá!");exam=e[t],showWaiting()}}function showWaiting(){document.getElementById("loginSection").classList.add("hidden"),document.getElementById("waitingSection").classList.remove("hidden"),document.getElementById("welcome").textContent=`Ch√†o ${name}!`,document.getElementById("title").textContent=exam.title,document.getElementById("duration").textContent=exam.duration,document.getElementById("count").textContent=exam.questions.length}function start(){document.getElementById("waitingSection").classList.add("hidden"),document.getElementById("examSection").classList.remove("hidden"),document.getElementById("titleTop").textContent=exam.title,answers={},showQuestions(),startTimer(),detectTab(),document.getElementById("warning").classList.remove("hidden")}function showQuestions(){const e=document.getElementById("questions");e.innerHTML="",exam.questions.forEach((t,n)=>{const i=document.createElement("div");i.className="question-container";let s=`<div class="question-number">C√¢u ${n+1}</div><div class="question-content">${t.question}</div><div class="choices">`;t.choices.forEach((e,t)=>{s+=`<label class="choice-label"><input type="radio" name="q${n}" value="${t}" onchange="save(${n}, ${t})"><span>${String.fromCharCode(65+t)}. ${e}</span></label>`}),s+="</div>",i.innerHTML=s,e.appendChild(i)})}function save(e,t){answers[e]=t}function startTimer(){startTime=Date.now();let e=60*exam.duration;timer=setInterval(()=>{e--;const t=Math.floor(e/60),n=e%60,i=document.getElementById("timer");i.textContent=`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}`,e<=300&&i.classList.add("warning"),e<=0&&(clearInterval(timer),submit(!0))},1e3)}function detectTab(){document.addEventListener("visibilitychange",()=>{document.hidden&&!submitted&&(tabSwitch=!0,alert("‚ö†Ô∏è ƒê√£ ph√°t hi·ªán chuy·ªÉn tab! T·ª± ƒë·ªông n·ªôp b√†i."),submit(!0))})}async function submit(e=!1){if(submitted)return;submitted=!0,timer&&clearInterval(timer);let t=0;exam.questions.forEach((e,n)=>{answers[n]===e.correctAnswer&&t++});const n=exam.questions.length,i=parseFloat((t/n*10).toFixed(1)),s={name:name,code:code,examTitle:exam.title,score:i,correct:t,total:n,answers:answers,tabSwitch:tabSwitch,time:(new Date).toISOString()};if(db)try{const e=db.ref("results").push();s.id=e.key,await e.set(s)}catch(e){console.error(e),saveLocal(s)}else saveLocal(s);document.getElementById("examSection").classList.add("hidden"),showResult(t,n,i,e)}function saveLocal(e){const t=JSON.parse(localStorage.getItem("results")||"[]");t.push(e),localStorage.setItem("results",JSON.stringify(t))}function showResult(e,t,n,i){document.getElementById("resultSection").classList.remove("hidden"),document.getElementById("score").textContent=n,document.getElementById("resultName").textContent=name,document.getElementById("correct").textContent=e,document.getElementById("total").textContent=t;let s=i?tabSwitch?"‚ö†Ô∏è T·ª± ƒë·ªông n·ªôp do chuy·ªÉn tab!":"‚è∞ T·ª± ƒë·ªông n·ªôp do h·∫øt gi·ªù!":"‚úì N·ªôp b√†i th√†nh c√¥ng!";document.getElementById("msg").textContent=s,showDetails()}function showDetails(){const e=document.getElementById("details");e.innerHTML="<h3>Chi Ti·∫øt:</h3>",exam.questions.forEach((t,n)=>{const i=answers[n],s=t.correctAnswer,o=i===s,a=document.createElement("div");a.className=`result-question ${o?"correct":"incorrect"}`;let c=`<div class="question-text">C√¢u ${n+1}: ${t.question}</div><div class="answer-info">`;c+=void 0!==i?`B·∫°n ch·ªçn: <span class="${o?"correct-answer":"wrong-answer"}">${String.fromCharCode(65+i)}. ${t.choices[i]}</span><br>`:'B·∫°n ch·ªçn: <span class="wrong-answer">Kh√¥ng tr·∫£ l·ªùi</span><br>',o||(c+=`ƒê√°p √°n ƒë√∫ng: <span class="correct-answer">${String.fromCharCode(65+s)}. ${t.choices[s]}</span>`),c+="</div>",a.innerHTML=c,e.appendChild(a)})}window.addEventListener("load",()=>{initFirebase()}),window.addEventListener("beforeunload",e=>{submitted||!startTime||(e.preventDefault(),e.returnValue="B√†i thi ch∆∞a n·ªôp!")});
